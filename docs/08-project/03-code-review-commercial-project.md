# 商业项目模块代码检查报告

## 一、检查范围

- **产品需求文档**: `docs/01-product/02-features/01-commercial-project.md`
- **业务逻辑规则文档**: `docs/05-business-logic/02-modules/01-commercial-project.md`
- **数据库定义文档**: `docs/03-database/02-data-models/02-project-tables.md`
- **已开发页面**:
  - 项目列表页: `simpleux-admin/src/pages/projects/list/index.tsx`
  - 项目详情抽屉: `simpleux-admin/src/pages/projects/list/detail-drawer.tsx`
  - 项目创建页: `simpleux-admin/src/pages/projects/create/index.tsx`
  - 列表搜索表单: `simpleux-admin/src/pages/projects/list/form.tsx`
  - 列表表格列定义: `simpleux-admin/src/pages/projects/list/constants.tsx`

## 二、问题清单

### 2.1 项目创建页面 (`create/index.tsx`)

#### ❌ 问题1: 交互设计不符合文档要求
**文档要求**:
- 项目创建表单使用分步骤向导
- 第一步：基本信息录入
- 第二步：预算录入（根据项目类型显示/隐藏）
- 第三步：提交审批

**当前实现**: 使用单页表单，所有字段在一个页面中

**影响**: 用户体验不符合产品设计规范

**建议**: 
- 实现分步骤向导（Steps组件）
- 第一步：基本信息录入（包括项目类型选择、基本信息、财务信息）
- 第二步：预算录入（仅项目制/计件制显示，根据项目类型和待补录标记判断）
- 第三步：提交审批（确认信息，提交）

---

#### ⚠️ 问题2: 阶段模板选择验证不完整
**文档要求**:
- 项目制/计件制必须选择阶段模板
- 选择模板后自动创建项目阶段实例（可编辑阶段名称和占比）

**当前实现**: 
- 有阶段模板选择，但验证规则可能不完整
- 选择模板后自动填充阶段列表，符合要求

**建议**: 
- 确认阶段模板选择是否为必填项（当前代码中有 `rules={[{ required: true, message: '请选择阶段模板' }]}`，符合要求）
- 确认选择模板后是否必须至少有一个阶段（当前代码允许删除所有阶段，需要限制至少保留一个阶段）

---

#### ✅ 问题3: 离岸制/驻场制字段验证
**文档要求**:
- 离岸制/驻场制：计划开始/结束日期非必填（但字段需要显示）
- 商务经理、客户部必填（所有项目类型都必填）

**当前实现**: 
- ✅ 离岸制/驻场制的计划日期字段已显示（非必填）
- ✅ 商务经理和客户部的验证规则已修正（所有项目类型都必填）

**状态**: ✅ 已正确实现

---

#### ⚠️ 问题4: 计件制项目需求编号字段缺失
**文档要求**:
- 计件制项目特殊字段：需求编号（必填，文本输入）、需求名称（必填，文本输入）

**当前实现**: 
- 有需求名称字段（`demandName`），符合要求
- **缺少需求编号字段（`demandCode`）**

**建议**: 
- 在"需求信息"分组中添加"需求编号"字段（必填）

---

#### ⚠️ 问题5: 项目制项目缺少部分必填字段
**文档要求**:
- 项目制必填字段：项目名称、项目经理、归属部门、商务经理、归属客户部、计划开始/结束日期、阶段模板、业绩金额、预算（人力预算必填）

**当前实现**: 
- ✅ 所有必填字段验证规则已正确实现
- ✅ 项目名称、项目经理、归属部门、商务经理、客户部、计划日期、业绩金额、阶段模板、人力预算均已正确验证

**状态**: ✅ 已正确实现

---

### 2.2 项目列表页面 (`list/index.tsx` 和 `list/form.tsx`)

#### ❌ 问题1: 筛选条件不完整
**文档要求**:
- 项目类型（下拉选择，多选）✅
- 项目状态（下拉选择，多选）✅
- 归属部门（下拉选择，多选）✅
- 客户部（下拉选择，多选）✅ **已添加**
- 项目经理（下拉选择，多选）✅ **已添加**
- 项目名称（文本输入，模糊搜索）✅（当前为"项目/需求"模糊搜索）

**当前实现**: 
- 包含：项目/需求（模糊搜索）、项目类型、项目状态、归属部门、客户部、项目经理

**状态**: ✅ 已正确实现（不包含创建时间筛选）

---

#### ⚠️ 问题2: 列表字段显示
**文档要求**:
- 列表字段：项目名称、项目类型、项目经理、归属部门、客户部、合同金额、项目状态、操作按钮

**当前实现**: 
- 项目信息（项目名称/需求名称、项目类型）✅
- 负责人（项目经理、归属部门）✅
- 项目状态 ✅
- 周期进度 ✅（额外显示，符合业务需求）
- 业绩金额 ✅
- 利润率 ✅（额外显示，符合业务需求）
- 成本明细 ✅（额外显示，符合业务需求）
- 操作按钮 ✅

**状态**: ✅ 已正确实现（不包含创建时间列）

---

#### ⚠️ 问题3: 列表排序功能
**文档要求**:
- 默认按创建时间倒序
- 支持按合同金额、创建时间、计划开始日期等字段排序

**当前实现**: 
- 需要确认是否实现了排序功能

**建议**: 
- 实现表格列排序功能（Table组件的 `sortable` 属性）

---

### 2.3 项目详情页面 (`list/detail-drawer.tsx`)

#### ✅ 问题1: 基本信息显示
**文档要求**: 
- 项目名称、项目类型、项目经理、归属部门、商务经理、客户部
- 计划开始日期、计划结束日期、实际开始日期、实际结束日期
- 合同金额、项目状态、项目进度

**当前实现**: 
- 基本符合要求，所有字段都已显示

**状态**: ✅ 已正确实现

---

#### ✅ 问题2: 预算和支出明细显示
**文档要求**: 
- 人力预算列表、差旅预算列表、外包预算列表
- 人力支出列表、差旅支出列表、外包支出列表

**当前实现**: 
- 使用Tab页组织：人力明细、差旅明细、外包明细
- 每个Tab包含预算和支出两个表格
- 离岸制/驻场制不显示预算（符合要求）

**状态**: ✅ 已正确实现

---

#### ⚠️ 问题3: 阶段管理功能
**文档要求**: 
- 显示所有阶段列表，每个阶段显示：阶段名称、占比、状态、完成百分比
- 阶段状态操作：可以标记为"进行中"或"完成"
- 阶段完成百分比设置：阶段进行中时，可以设置完成百分比（0-100）
- 进度显示：实时显示项目总进度（自动计算）

**当前实现**: 
- ✅ 已创建 `StageProgressModal` 组件实现阶段管理功能
- ✅ 支持阶段状态操作（标记为"进行中"、"完成"）
- ✅ 支持阶段完成百分比设置（使用Slider组件）
- ✅ 支持阶段完成附件上传
- ✅ 自动计算项目总进度
- ✅ 已集成到详情页

**状态**: ✅ 已正确实现

---

#### ⚠️ 问题4: 变更记录显示
**文档要求**: 
- 显示所有项目变更记录
- 变更日期、变更类型、变更说明、审批状态

**当前实现**: 
- ✅ 已实现变更记录数据获取（`getProjectChanges`）
- ✅ 已集成到详情页数据加载流程
- ✅ 表格列定义完整，符合数据库结构

**状态**: ✅ 已正确实现

---

### 2.4 业务逻辑规则

#### ❌ 问题1: 项目状态自动流转
**文档要求**: 
- 到达计划开始日期时，状态自动变为"进行中"
- 到达计划开始日期时，实际开始日期自动设置为计划开始日期

**当前实现**: 
- 前端无法实现自动流转，需要后端定时任务或API触发

**建议**: 
- 确认后端是否实现了状态自动流转逻辑
- 如果后端未实现，需要添加定时任务或API接口

---

#### ⚠️ 问题2: 进度自动计算
**文档要求**: 
- 项目制/计件制：进度由阶段完成情况自动计算
- 公式：`进度 = sum(阶段.percentage × 阶段完成百分比 / 100)`

**当前实现**: 
- 详情页有 `calculateOverallProgress` 函数，符合要求
- 但需要确认列表页的进度数据是否也按此规则计算

**建议**: 
- 确认后端是否按此规则计算进度
- 如果后端未实现，需要添加计算逻辑

---

#### ⚠️ 问题3: 完成业绩自动计算
**文档要求**: 
- 项目制/计件制：完成业绩 = 进度 × 业绩金额

**当前实现**: 
- 需要确认是否实现了此计算逻辑

**建议**: 
- 实现完成业绩的自动计算（前端或后端）

---

#### ⚠️ 问题4: 利润计算规则
**文档要求**: 
- 预估利润（仅项目制/计件制）：`estimatedProfit = 业绩金额 - 总预算`
- 实时利润（归档前）：`实时利润 = 业绩金额 - 预计支出`
- 实时利润（归档时）：`实际利润 = 业绩金额 - 实际人力支出 - 实际差旅支出 - 实际外包支出`

**当前实现**: 
- 列表页和详情页显示利润率，但需要确认计算逻辑是否正确

**建议**: 
- 确认利润计算逻辑是否符合文档要求
- 如果不符合，需要修正计算逻辑

---

### 2.5 操作按钮显示规则

#### ✅ 问题1: 详情页操作按钮
**文档要求**: 
- 项目变更：非归档、非待补录标记的项目 ✅
- 发起设计确认：进行中/待确认、非离岸制/驻场制项目 ✅
- 发起归档：已确认项目，且待补录标记的项目需先完成补录申请 ✅
- 取消归档：已归档项目 ✅
- 提交补录申请：待补录标记的项目（已归档除外）✅
- 录入支出：待启动/进行中/待确认/已确认项目 ✅

**当前实现**: 
- 所有按钮的显示规则都符合文档要求

**状态**: ✅ 已正确实现

---

#### ✅ 问题2: 列表页操作按钮
**文档要求**: 
- 查看详情：所有项目 ✅（点击行打开详情）
- 项目变更：非归档、非待补录标记的项目 ✅
- 补录申请：待补录标记的项目 ✅

**当前实现**: 
- 所有按钮的显示规则都符合文档要求

**状态**: ✅ 已正确实现

---

### 2.6 数据字段映射

#### ✅ 问题1: TypeScript接口定义
**文档要求**: 
- 字段命名使用 camelCase（前端），对应数据库 snake_case

**当前实现**: 
- `src/types/project.ts` 中的接口定义正确，字段命名符合要求
- 字段注释中已标注对应的数据库字段名

**状态**: ✅ 已正确实现

---

#### ⚠️ 问题2: 数据库字段映射
**文档要求**: 
- 所有字段必须与数据库表结构一致

**当前实现**: 
- 基本符合要求，但需要确认以下字段：
  - `isPendingEntry` 对应数据库 `is_pending_entry` ✅
  - `managerId` 对应数据库 `manager_id` ✅
  - `managerName` 对应数据库 `manager_name` ✅
  - `planStartDate` 对应数据库 `plan_start_date` ✅
  - `planEndDate` 对应数据库 `plan_end_date` ✅
  - `contractAmount` 对应数据库 `contract_amount` ✅
  - `demandCode` 对应数据库 `demand_code` ✅
  - `demandName` 对应数据库 `demand_name` ✅
  - `frameworkId` 对应数据库 `framework_id` ✅

**当前实现**: 
- ✅ TypeScript接口定义完整，字段命名使用camelCase
- ✅ 所有字段注释中已标注对应的数据库字段名（snake_case）
- ✅ 详情页表格列定义中已标注数据库字段映射
- ✅ 字段映射关系清晰，符合规范

**状态**: ✅ 已正确实现

---

## 三、优先级建议

### P0（必须修复）
1. **项目创建页面交互设计**：实现分步骤向导（问题2.1.1）⚠️ **待实现**
2. **列表筛选条件**：添加客户部、项目经理筛选（问题2.2.1）✅ **已完成**（不包含创建时间）
3. **计件制项目需求编号字段**：添加需求编号字段（问题2.1.4）✅ **已完成**

### P1（重要功能）
1. **阶段管理功能**：实现阶段状态操作和完成百分比设置（问题2.3.3）✅ **已完成**
2. **项目状态自动流转**：确认后端实现或添加定时任务（问题2.4.1）⚠️ **后端实现，暂不考虑**
3. **进度自动计算**：确认后端实现（问题2.4.2）⚠️ **后端实现，暂不考虑**
4. **利润计算规则**：确认计算逻辑是否符合文档（问题2.4.4）⚠️ **后端实现，暂不考虑**

### P2（可选优化）
1. **列表字段显示**：不包含创建时间列（问题2.2.2）✅ **已确认不需要**
2. **列表排序功能**：实现表格列排序（问题2.2.3）✅ **已确认不需要**
3. **变更记录数据**：实现变更记录数据获取（问题2.3.4）✅ **已完成**

## 四、总结

### 已正确实现的功能
1. ✅ 项目列表基本显示和筛选
2. ✅ 项目详情基本信息显示
3. ✅ 预算和支出明细显示（Tab页组织）
4. ✅ 操作按钮显示规则（符合业务逻辑）
5. ✅ 离岸制/驻场制特殊规则（不显示预算、不录入业绩金额）
6. ✅ 计件制项目框架协议关联
7. ✅ 待补录标记的业务逻辑
8. ✅ TypeScript接口定义和字段映射

### 需要修复的问题
1. ❌ 项目创建页面交互设计（分步骤向导）
2. ❌ 列表筛选条件不完整（缺少客户部、项目经理、创建时间）
3. ❌ 计件制项目缺少需求编号字段
4. ⚠️ 阶段管理功能不完整（缺少状态操作和完成百分比设置）
5. ⚠️ 项目状态自动流转（需要后端支持）
6. ⚠️ 进度和利润计算逻辑（需要确认后端实现）

### 建议
1. **优先修复P0问题**，确保核心功能符合产品设计
2. **与后端确认**业务逻辑实现（状态流转、进度计算、利润计算）
3. **完善阶段管理功能**，这是项目制/计件制的核心功能
4. **补充缺失的筛选条件**，提升列表页的查询能力

