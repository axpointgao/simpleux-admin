# 业务逻辑规则文档概述

## 一、文档说明

本文档体系定义了整个系统的业务逻辑规则，包括数据模型、业务流程、业务规则、权限控制等。这些规则是系统开发的基础，开发人员必须严格按照这些规则进行实现。

## 二、文档结构

业务逻辑规则文档按模块组织，每个模块包含：
1. **数据模型**：核心实体的字段定义和业务规则
2. **业务流程**：业务操作的完整流程
3. **业务规则**：具体的业务约束和验证规则
4. **权限控制**：权限验证规则
5. **交互设计**：用户界面和交互说明

## 三、术语定义

### 3.1 通用术语

- **业务实体**：系统中的核心业务对象，如项目、商机、专业贡献、业绩等
- **状态流转**：业务实体从一种状态转换到另一种状态的过程
- **审批流程**：需要审批的业务操作，通过审批流程模板定义
- **权限控制**：根据用户角色和部门，控制用户对业务实体的操作权限

### 3.2 项目相关术语

- **项目制**：独立项目，有明确的业绩金额和交付周期
- **计件制**：基于框架协议的需求项，按件计费
- **离岸制**：按人月结算，远程交付，按月录入业绩
- **驻场制**：驻点客户现场工作，按月结算，按月录入业绩
- **框架协议**：计件制项目必须关联的主项目
- **待补录**：计件制项目创建时选择"待补录"模式，跳过预算和业绩金额录入

### 3.3 业绩相关术语

- **业绩金额**：项目的业绩金额，与项目类型相关
- **登记状态**：业绩是否已登记（未登记/已登记）
- **验收**：业绩验收，可分批验收，需要审批
- **结算**：业绩结算，可分批结算
- **到账**：业绩到账，可分批到账，与结算无关
- **业绩拆分**：将业绩拆分到不同部门，用于处理跨部门借人

### 3.4 任务和工时相关术语

- **计划工时**：分配给任务的计划工作时间
- **实际工时**：任务执行者实际工作的时间
- **合计工时模式**：输入总工时，系统自动均分到每个工作日
- **每天工时模式**：输入每天工时，系统为每个工作日分配相同工时

### 3.5 审批相关术语

- **审批类型**：不同类型的审批，如项目创建、项目变更、专业贡献立项等
- **审批步骤**：审批流程中的每个步骤
- **审批人**：负责审批的人员
- **钉钉待办**：通过钉钉发送的待办任务，点击后跳转到系统内审批页面

## 四、通用业务规则

### 4.1 数据完整性规则

1. **唯一性约束**：
   - 所有实体的ID必须唯一
   - 编码字段（code）必须唯一（如果存在）
   - 名称字段在某些场景下需要唯一（如供应商名称）

2. **必填字段规则**：
   - 核心字段必须填写
   - 根据业务实体类型，某些字段可能为必填或可选

3. **关联关系规则**：
   - 外键关联必须有效
   - 删除业务实体时，需要考虑关联数据的处理

### 4.2 状态流转规则

1. **状态定义**：
   - 每个业务实体都有明确的状态定义
   - 状态值使用枚举类型，不允许随意定义

2. **状态流转**：
   - 状态流转有明确的前置条件
   - 状态流转不可逆（除非特殊说明）
   - 状态流转需要权限验证

3. **状态约束**：
   - 某些操作只能在特定状态下执行
   - 状态变更会触发相应的业务逻辑

### 4.3 权限控制规则

1. **权限类型**：
   - **查看权限**：查看业务实体列表和详情
   - **创建权限**：创建新的业务实体
   - **编辑权限**：修改业务实体信息
   - **删除权限**：删除业务实体（通常为软删除）
   - **审批权限**：进行审批操作

2. **权限判断**：
   - 基于用户角色和部门
   - 基于业务实体的归属部门
   - 基于业务实体的创建者

3. **权限验证**：
   - 所有操作都需要进行权限验证
   - 权限验证失败时，返回明确的错误信息

### 4.4 金额计算规则

1. **金额精度**：
   - 金额使用数字类型，保留两位小数
   - 金额比较时，需要考虑浮点数精度问题
   - 使用精度判断：`Math.abs(amount - target) < 0.01`

2. **金额验证**：
   - 金额必须 >= 0
   - 某些场景下，金额必须 > 0
   - 金额合计验证（如业绩拆分金额合计必须等于业绩金额）

3. **金额计算**：
   - 使用 `BigNumber` 或 `decimal.js` 处理金额计算
   - 统一金额单位（元）
   - 避免浮点数精度问题

### 4.5 日期时间规则

1. **日期格式**：
   - 日期格式：`YYYY-MM-DD`
   - 月份格式：`YYYY-MM`
   - 时间戳：使用Unix时间戳（秒）或ISO 8601格式

2. **日期验证**：
   - 结束日期必须晚于或等于开始日期
   - 某些日期不能是未来日期（如结算日期、到账日期）

3. **工作日计算**：
   - 自动排除周末（周六和周日）
   - 自动排除节假日（从节假日配置中获取）
   - 包含调休工作日

## 五、模块列表

### 5.1 核心业务模块

1. **商业项目管理**（`01-commercial-project.md`）
   - 项目创建、状态流转、预算管理、支出管理、变更管理、补录申请、设计确认、归档

2. **业绩管理**（`02-performance-management.md`）
   - 业绩登记、验收、结算、到账、业绩拆分

3. **售前支持**（`03-presales-opportunity.md`）
   - 商机管理、跟进记录、成本管理、任务和工时管理

4. **专业贡献**（`04-professional-contribution.md`）
   - 立项申请、审批、任务管理、验收申请、评级

5. **任务和工时管理**（`05-task-workhour-management.md`）
   - 任务创建、计划工时分配、实际工时录入、工时统计

6. **其他任务**（集成在任务和工时管理模块中）
   - 主管给下属创建任务、分配计划工时、录入实际工时

7. **审批管理**（`06-approval-management.md`）
   - 审批创建、审批执行、审批列表、审批详情、钉钉待办集成

8. **系统设置**（`07-system-settings.md`）
   - 人日成本设置、角色权限设置、审批流程设置、节假日管理、客户部管理、数据同步设置、通知设置、供应商管理

### 5.2 模块间关系

- **商业项目** ↔ **业绩管理**：项目业绩金额与项目业绩记录双向同步
- **商业项目** ↔ **任务和工时管理**：项目可以关联多个任务
- **售前支持** ↔ **任务和工时管理**：商机可以关联多个任务
- **专业贡献** ↔ **任务和工时管理**：专业贡献审批通过后自动创建任务
- **所有业务模块** ↔ **审批管理**：各业务模块的审批流程统一管理
- **所有业务模块** ↔ **系统设置**：依赖系统设置中的配置（如成本标准、审批流程模板等）

## 六、文档阅读指南

### 6.1 开发人员阅读顺序

1. **先阅读本文档**：了解业务逻辑规则文档的整体结构和通用规则
2. **阅读相关模块文档**：根据开发任务，阅读对应的模块文档
3. **参考其他模块文档**：了解模块间的关系和依赖

### 6.2 文档使用建议

1. **开发前**：仔细阅读相关模块的业务逻辑规则文档
2. **开发中**：遇到业务规则问题时，查阅文档确认
3. **开发后**：对照文档检查实现是否符合业务规则

### 6.3 文档更新

1. **业务规则变更**：及时更新相关文档
2. **新增功能**：补充新的业务规则文档
3. **文档审查**：重要变更需要经过审查

## 七、注意事项

1. **严格遵循**：开发人员必须严格按照业务逻辑规则进行实现
2. **及时沟通**：如果发现业务规则不清晰或存在冲突，及时与产品经理沟通
3. **文档同步**：代码实现变更时，确保文档同步更新
4. **测试验证**：开发完成后，对照文档进行测试验证

