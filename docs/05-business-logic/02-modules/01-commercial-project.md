# 商业项目管理模块业务逻辑规则

## 一、数据模型

### 1.1 核心实体

#### Project（项目）

**项目类型（`type`）**：

- `项目制`（PROJECT_BASED）：独立项目，有明确的业绩金额和交付周期
- `计件制`（PIECEWORK）：基于计件项目的需求项，按件计费
- `离岸制`（OFFSHORE）：按人月结算，远程交付，按月录入业绩
- `驻场制`（ONSITE）：驻点客户现场工作，按月结算，按月录入业绩

**项目状态（`status`）**：

- `待启动`（PENDING_START）：项目已创建，等待启动
- `进行中`（IN_PROGRESS）：项目正在执行中
- `待确认`（PENDING_CONFIRM）：项目完成，等待确认
- `已确认`（CONFIRMED）：项目已确认完成
- `已归档`（ARCHIVED）：项目已归档，默认隐藏

**待补录标记（`isPendingEntry`）**：

- 类型：`boolean`
- 说明：待补录不是独立的状态，而是一个标记字段
- 业务场景：计件制项目创建时选择"待补录"模式，跳过预算和业绩金额录入
- 规则：待补录的项目可以是"待启动"、"进行中"、"待确认"、"已确认"等状态
- 补录申请通过后，可清除标记（`isPendingEntry = false`）或保留用于历史记录

**核心字段**：

- `id`: 项目 ID（唯一标识）
- `code`: 项目编号（自动生成，格式：PROJ-YYYYMMDD-XXXX，不在 UI 中显示）
  - 格式说明：固定码（PROJ）+ 年月日（YYYYMMDD，8 位）+ 序号（XXXX，4 位，从 0001 开始）
  - 示例：PROJ-20241201-0001
- `name`: 项目名称（项目制）或主项目名称（计件制）
- `type`: 项目类型
- `manager`: 项目经理（姓名）
- `group`: 归属部门（Department 枚举）
- `bizManager`: 商务经理（姓名）
- `clientDept`: 归属客户部（ClientDepartment 枚举）
- `planStartDate`: 计划开始日期
- `planEndDate`: 计划结束日期
- `actualStartDate`: 实际开始日期（可选）
- `actualEndDate`: 实际结束日期（可选）
- `status`: 项目状态
- `progress`: 项目进度（0-100，项目制/计件制由阶段完成情况自动计算）
- `contractAmount`: 业绩金额
- `completedAmount`: 完成业绩（进度 × 业绩金额，项目制/计件制自动计算）
- `lastUpdated`: 最后更新时间

**计件制专用字段**：

- `demandCode`: 需求编号（自动生成，格式：DEM-YYYYMMDD-XXXX）
  - 格式说明：固定码（DEM）+ 年月日（YYYYMMDD，8 位）+ 序号（XXXX，4 位，从 0001 开始）
  - 示例：DEM-20241201-0001
- `demandName`: 需求名称
- `frameworkId`: 关联的计件项目 ID（主项目）

**财务统计字段（`stats`）**：

- `budgetLabor`: 人力预算总额
- `actualLabor`: 人力实际支出总额
- `budgetTravel`: 差旅预算总额
- `actualTravel`: 差旅实际支出总额
- `budgetOutsource`: 外包预算总额
- `actualOutsource`: 外包实际支出总额
- `estimatedProfit`: 预估利润（业绩金额 - 总预算，仅项目制/计件制）
- `projectedProfit`: 实时利润
  - 归档前：业绩金额 - 预计支出（预计支出 = 预计人力支出 + 差旅预算 + 外包预算）
  - 归档时：根据实际支出重新计算（实际利润 = 业绩金额 - 实际人力支出 - 实际差旅支出 - 实际外包支出）

**预算明细（`budgetDetails`）**：

- 人力预算：`employeeLevel`、`cityType`、`days`、`unitCost`、`amount`
- 差旅预算：`item`、`transportBig`、`stay`、`transportSmall`、`allowance`、`other`、`amount`
- 外包预算：`item`、`vendor`、`amount`

**支出明细（`expenseDetails`）**：

- 人力支出：`month`、`employeeName`、`employeeLevel`、`plannedHours`、`hours`、`amount`（通过系统内的任务和工时管理模块录入）
- 差旅支出：`month`、`item`、`transportBig`、`stay`、`transportSmall`、`allowance`、`other`、`amount`
- 外包支出：`month`、`item`、`vendor`、`amount`

**阶段信息（`stages`）**（项目制/计件制）：

- 阶段列表：每个阶段包含`name`（阶段名称）、`percentage`（占比）、`status`（状态：pending/in_progress/completed）、`completionPercentage`（阶段完成百分比，0-100）、`completedAt`（完成时间）、`completedBy`（完成人）、`attachmentUrl`（完成附件）

#### Framework Agreement（计件项目/主项目）

**说明**：计件制项目必须关联到一个计件项目（主项目）

**核心字段**：

- `id`: 计件项目 ID
- `code`: 计件项目编号（自动生成，格式：FRAM-YYYYMMDD-XXXX，不在 UI 中显示）
  - 格式说明：固定码（FRAM）+ 年月日（YYYYMMDD，8 位）+ 序号（XXXX，4 位，从 0001 开始）
  - 示例：FRAM-20241201-0001
- `name`: 主项目名称
- `manager`: 项目经理
- `bizManager`: 商务经理
- `dept`: 归属部门
- `clientDept`: 归属客户部

**业务规则**：

- 计件制项目创建时，必须选择或创建计件项目
- 选择计件项目后，自动带出项目经理、商务经理、归属部门、归属客户部等信息
- 计件项目字段修改不需要审批，但会同步到关联需求的相关字段（建议采用同步方式，即需求不单独存储主项目字段，而是实时读取计件项目的最新信息）
- **删除限制**：计件项目在有关联的需求（计件制项目）时不允许删除，必须先删除或解除关联的需求后才能删除计件项目

#### ProjectChangeRecord（项目变更记录）

**变更类型（`changeType`）**：

- 计件制：`project`（主项目变更）、`demand`（需求变更）
- 项目制/离岸制/驻场制：`project`（项目变更）

**说明**：

- 变更类型主要用于区分计件制的主项目变更和需求变更（验证规则不同）
- 变更记录中已记录所有变更字段及其变更前后的值，可通过这些字段判断具体变更内容
- 不需要按字段细化类型（如名称变更、金额变更等），避免组合过多

**核心字段**：

- `id`: 变更记录 ID
- `projectId`: 关联的项目 ID
- `changeDate`: 变更日期
- `changeType`: 变更类型
- `description`: 变更说明（必填）
- `attachmentUrl`: 变更附件（必填）
- `approvalStatus`: 审批状态（'pending' | 'approved' | 'rejected'）
- `approvedBy`: 审批人
- `approvedAt`: 审批时间

**可变更的字段**（记录变更前后的值）：

- 项目名称/需求名称、项目经理、归属部门、商务经理、归属客户部
- 计划开始/结束日期、业绩金额、预算（人力/差旅/外包）

## 二、项目创建规则

### 2.1 项目类型选择

**项目制（PROJECT_BASED）**：

- 适用场景：独立项目，有明确的业绩金额和交付周期
- 必填字段：项目名称、项目经理、归属部门、商务经理、归属客户部、计划开始/结束日期、阶段模板、业绩金额、预算（人力预算必填，差旅和外包可选）
- 特殊规则：
  - 业绩金额在创建时录入，后续可在业绩管理模块中修改（修改后同步更新项目的业绩金额）
  - 必须选择阶段模板，选择后自动创建项目阶段实例（可编辑阶段名称和占比）

**计件制（PIECEWORK）**：

- 适用场景：基于计件项目的需求项，按件计费
- 必填字段：计件项目（主项目）、需求名称、计划开始/结束日期、阶段模板、业绩金额（补录模式下不填写）、预算（人力预算必填，差旅和外包可选，补录模式下不填写）
- 特殊规则：
  - 必须选择或创建计件项目，选择后自动带出项目经理、商务经理、归属部门、归属客户部
  - 计件项目信息可以手动修改（修改后同步到关联需求）
  - 必须选择阶段模板，选择后自动创建项目阶段实例（可编辑阶段名称和占比）
  - 业绩金额在创建时录入（从需求金额获取），后续可在业绩管理模块中修改（修改后同步更新需求的业绩金额）
  - 支持"补录"模式：选择"待补录"时，跳过预算和业绩金额录入，设置 `isPendingEntry = true`，项目状态为"待启动"
  - **待补录只有在创建时才能选择，不能在创建后改成待补录**

**离岸制（OFFSHORE）**：

- 适用场景：按人月结算，远程交付，按月录入业绩
- 必填字段：项目名称、项目经理、归属部门、商务经理、归属客户部
- 特殊规则：
  - 不需要录入预算（预算为 0）
  - 计划开始/结束日期非必填（但字段需要显示）
  - **业绩金额**：创建时不录入，后续在业绩管理模块中按月手动录入，系统自动累加所有月份业绩记录的金额到项目的业绩金额
  - **人力成本计算**：来源于人员的工时 × 等级单价（手动录入工时数据，自动计算成本）
  - 不需要展示财务汇总信息

**驻场制（ONSITE）**：

- 适用场景：驻点客户现场工作，按月结算，按月录入业绩
- 必填字段：项目名称、项目经理、归属部门、商务经理、归属客户部
- 特殊规则：
  - 不需要录入预算（预算为 0）
  - 计划开始/结束日期非必填（但字段需要显示）
  - **业绩金额**：创建时不录入，后续在业绩管理模块中按月手动录入，系统自动累加所有月份业绩记录的金额到项目的业绩金额
  - **人力成本计算**：来源于人员的薪资（做成本录入时按月录）
  - 不需要展示财务汇总信息

### 2.2 表单验证规则

**通用验证**：

- 项目名称/需求名称：必填，不能为空
- 计划开始/结束日期：必填（离岸制/驻场制除外），结束日期必须晚于开始日期

**项目制验证**：

- 项目经理、归属部门、商务经理、归属客户部：必填
- 阶段模板：必填
- 业绩金额：必填，必须 > 0
- 人力预算：必填，至少一条记录，每条记录必须完整（人员等级、城市类型、工作天数）
- 差旅预算、外包预算：非必填
- 阶段占比验证：所有阶段占比之和必须等于 100%

**计件制验证**：

- 计件项目：必填
- 需求名称：必填
- 阶段模板：必填
- 业绩金额：必填，必须 > 0（补录模式下不填写）
- 人力预算：必填（事后补录的除外），至少一条记录，每条记录必须完整
- 差旅预算、外包预算：非必填
- 阶段占比验证：所有阶段占比之和必须等于 100%

**预算验证**：

- 人力预算：人员等级、城市类型、工作天数必填，单价和金额自动计算
- 差旅预算：出差事项必填，至少一项费用 > 0，金额自动计算
- 外包预算：外包事项、供应商、金额必填，金额必须 > 0

### 2.3 成本计算规则

**人力成本矩阵（COST_MATRIX）从配置中获取**：

```
P5: 成都 1000元/天，杭州 1400元/天
P6: 成都 1500元/天，杭州 2000元/天
P7: 成都 2200元/天，杭州 2800元/天
P8: 成都 3000元/天，杭州 3800元/天
M1: 成都 2500元/天，杭州 3200元/天
M2: 成都 3500元/天，杭州 4500元/天
```

**计算公式**：

- 人力预算：`unitCost = COST_MATRIX[level][city]`，`amount = days × unitCost`
- 差旅预算：`amount = transportBig + stay + transportSmall + allowance + other`
- 财务汇总：`laborTotal = sum(人力预算明细.amount)`，`travelTotal = sum(差旅预算明细.amount)`，`outsourceTotal = sum(外包预算明细.amount)`，`totalCost = laborTotal + travelTotal + outsourceTotal`，`estimatedProfit = contractAmount - totalCost`

## 三、项目状态流转规则

### 3.1 状态流转图

```
待启动 → 进行中 → 待确认 → 已确认 → 已归档
  ↓         ↓
设计确认
```

**说明**：待补录是标记字段（`isPendingEntry`），不是独立状态。待补录的项目可以处于"待启动"、"进行中"、"待确认"、"已确认"等状态，遵循正常的状态流转规则。

### 3.2 状态流转规则

**待启动（PENDING_START）**：

- 初始状态：项目创建后，默认状态为"待启动"
- 可执行操作：项目变更、标记阶段完成、补录申请（计件制待补录项目）

**进行中（IN_PROGRESS）**：

- 触发条件：到达计划开始日期时，状态自动变为"进行中"
- 自动处理：到达计划开始日期时，系统自动将状态从"待启动"变为"进行中"，并自动设置实际开始日期为计划开始日期（或允许手动调整）
- 可执行操作：项目变更、标记阶段完成、发起设计确认

**待确认（PENDING_CONFIRM）**：

- 触发条件：项目进度达到 100%（所有阶段完成）或手动设置为"待确认"
- 可执行操作：项目变更、标记阶段完成、确认完成（状态变为"已确认"）、补录申请（计件制待补录项目）

**已确认（CONFIRMED）**：

- 触发条件：项目确认完成
- 可执行操作：标记阶段完成（部分情况下会有售后、维护等工作）、发起归档、补录申请（计件制待补录项目）
- 不可执行操作：项目变更、发起设计确认

**已归档（ARCHIVED）**：

- 触发条件：已确认的项目发起归档申请并审批通过
- 可执行操作：取消归档（不需要审批，直接取消，状态变为"已确认"）
- 不可执行操作：项目变更、标记阶段完成、发起设计确认、补录申请
- 显示规则：默认隐藏，可通过"显示归档项目"筛选显示

**待补录标记（`isPendingEntry`）**：

- 触发条件：计件制项目创建时选择"待补录"模式（只有在创建时才能选择）
- 业务场景：一开始没有跟客户对需求金额达成一致，做完后或过程中来确认
- 可执行操作（根据实际状态）：
  - 项目变更：不可用
  - 标记阶段完成：可用（状态可以是"待启动"、"进行中"、"待确认"、"已确认"）
  - 发起设计确认：可用（状态为"进行中"或"待确认"时）
  - 归档：不可用（只有"已确认"状态才能归档，且需先完成补录申请）
  - 提交补录申请：可用（录入预算和业绩金额）

## 四、项目变更规则

### 4.1 变更前置条件

**可变更的项目**：待启动、进行中、待确认、已确认

**不可变更的项目**：已归档、待补录标记的项目（`isPendingEntry = true`）

### 4.2 变更类型和规则

**项目制变更**：

- 必填字段：项目名称、计划开始/结束日期、项目经理、归属部门、商务经理、归属客户部、业绩金额、阶段模板、人力预算（至少一条记录）
- 可变更字段：项目名称、项目经理、归属部门、商务经理、归属客户部、计划开始/结束日期、业绩金额、阶段（阶段名称、占比、添加/删除阶段）、预算（人力/差旅/外包）
- 阶段调整验证：调整后所有阶段占比之和必须等于 100%

**计件制变更**：

- 变更类型选择（必选）：
  - 主项目变更（`changeType = 'project'`）：变更计件项目相关信息（项目经理、归属部门、商务经理、归属客户部），不需要验证预算，变更后同步到关联需求
  - 需求变更（`changeType = 'demand'`）：变更需求相关信息（需求名称、计划时间、业绩金额、阶段、预算），需要验证预算和阶段占比
- 需求变更必填字段：需求名称、计划开始/结束日期、阶段模板、业绩金额、人力预算（如果修改预算，至少一条记录）
- 阶段调整验证：调整后所有阶段占比之和必须等于 100%

**变更说明和附件**：

- 变更说明：必填
- 变更附件：必填

**变更审批**：

- 提交后状态为"pending"（待审批）
- 审批通过后状态为"approved"，项目信息更新
- 审批拒绝后状态为"rejected"，项目信息不更新

## 五、补录申请规则

### 5.1 补录前置条件

**可补录的项目**：计件制项目，标记为"待补录"（`isPendingEntry = true`），可以是"待启动"、"进行中"、"待确认"、"已确认"等状态

### 5.2 补录表单验证

**必填字段**：

- 需求金额：必填，必须 > 0
- 预算：人力预算必填，差旅和外包可选

**预算验证**：

- 人力预算：每条记录必须完整（人员等级、城市类型、工作天数）
- 差旅预算：每条记录必须填写出差事项，至少一项费用 > 0
- 外包预算：每条记录必须填写外包事项、供应商、金额 > 0

**说明**：

- 补录申请不需要填写补录说明和补录附件
- 主项目信息（计件项目、项目经理、归属部门、商务经理、客户部）和需求信息（需求名称、计划日期）为只读展示，不可编辑
- 交付计划不需要填写：创建计件制需求时已经录入了交付计划，补录申请时不需要再次填写

### 5.3 补录流程

1. 选择待补录项目（`isPendingEntry = true`），点击"提交补录申请"
2. 填写需求金额和预算信息
3. 提交后，补录申请状态为"pending"（待审批）
4. 审批通过后：
   - **项目状态保持不变**（待补录是标记字段，不是状态）
   - 更新项目的业绩金额和预算信息
   - 更新财务统计（预算总额、预估利润等）
   - 可以清除"待补录"标记（`isPendingEntry = false`），或保留用于历史记录
   - 如果项目状态是"待启动"，到达计划开始日期时状态会自动变为"进行中"

## 六、预算和支出管理规则

### 6.1 预算录入规则

**项目制/计件制（事后补录的除外）**：

- 必须录入预算（人力预算必填，差旅和外包可选）

**离岸制/驻场制**：

- 不需要录入预算（预算为 0）
- 创建时不录入业绩金额和成本，业绩金额来源于业绩管理模块的累加
- 不需要展示财务汇总信息

**预算修改规则**：

- **预算只能通过项目变更流程修改**，不能直接在详情页进行增删改操作
- 项目创建时可以录入预算
- 项目变更时可以修改预算（人力/差旅/外包），需要提交变更申请并审批通过
- 补录申请时可以录入预算（仅限待补录的计件制项目），需要提交补录申请并审批通过
- 详情页的预算信息以只读方式展示，用于查看和核对

### 6.2 支出管理规则

**支出录入位置**：

- **项目详情页不提供支出录入功能**，支出录入统一在成本管理模块中进行
- 项目详情页仅提供支出数据的只读查看功能

**支出数据来源**：

- **人力支出**：来源于任务和工时管理模块，系统自动根据工时和人日成本标准计算成本
  - 项目制/计件制/离岸制：通过系统内的任务和工时管理模块录入实际工时，系统自动计算成本：`calculatedCost = hours / 8 * dailyCost`（工时 × 等级单价）
  - 驻场制：来源于人员的薪资，在成本管理模块中按月录入
- **差旅支出**：在成本管理模块中由财务人员统一录入
  - 必填字段：统计月份、出差事项
  - 费用明细：大交通、住宿、小交通、补助、其他
  - 金额自动计算：各项费用之和
- **外包支出**：在成本管理模块中由财务人员统一录入
  - 必填字段：统计月份、外包事项、供应商、金额（必须 > 0）

**项目详情页支出显示**：

- 项目详情页的"人力明细"、"差旅明细"、"外包明细"Tab 中仅显示支出数据
- 支持按月份筛选查看
- 支持导出支出明细
- 如需录入或修改支出，请前往成本管理模块

### 6.3 财务统计计算

**预算总额**（项目制/计件制）：

- `budgetLabor` = sum(人力预算明细.amount)
- `budgetTravel` = sum(差旅预算明细.amount)
- `budgetOutsource` = sum(外包预算明细.amount)

**实际支出总额**：

- `actualLabor` = sum(人力支出明细.amount)
  - 项目制/计件制/离岸制：通过系统内的任务和工时管理模块录入实际工时，自动计算成本（工时 × 等级单价）
  - 驻场制：来源于人员的薪资，按月录入成本
- `actualTravel` = sum(差旅支出明细.amount)
- `actualOutsource` = sum(外包支出明细.amount)

**业绩金额**：

- **项目制/计件制**：创建时录入的业绩金额（项目制在创建时手动录入，计件制从需求金额获取）
- **离岸制/驻场制**：创建时不录入，后续在业绩管理模块中按月手动录入，系统自动累加所有月份业绩记录的金额
- **同步规则**：业绩管理模块中业绩金额修改后，需同步更新关联项目/需求的业绩金额（`contractAmount`）

**利润计算**：

**预估利润**（仅项目制/计件制）：

- `estimatedProfit` = 业绩金额 - 总预算
- `profitRate` = (预估利润 / 业绩金额) × 100%
- 离岸制/驻场制：无预算，不计算预估利润

**实时利润**（`projectedProfit`）：

- 项目制/计件制（归档前）：实时利润 = 业绩金额 - 预计支出
  - 预计支出 = 预计人力支出 + 差旅预算 + 外包预算
  - 预计人力支出：根据当前已支出和进度情况计算（不是全额预算）
  - 差旅预算、外包预算：按全额预算计算
- 离岸制/驻场制：不计算实时利润，不展示财务汇总信息
- 归档时（项目制/计件制）：根据实际支出重新计算实际利润
  - 实际利润 = 业绩金额 - 实际人力支出 - 实际差旅支出 - 实际外包支出
  - 更新 `projectedProfit` 字段为实际利润

## 七、设计确认规则

### 7.1 设计确认前置条件

**可发起设计确认的项目**：

- 状态为"进行中"或"待确认"
- 非离岸制/驻场制项目
- 非已归档项目
- 待补录标记的项目：如果状态是"进行中"或"待确认"，也可以发起设计确认

**不可发起设计确认的项目**：待启动、已确认、已归档、离岸制/驻场制

### 7.2 设计确认流程

1. 点击"发起设计确认"按钮
2. 上传客户确认的邮件或 IM 截图（必填）
3. 填写确认说明（可选）
4. 提交后，设计确认申请状态为"pending"（待审批）
5. 审批通过后，记录设计确认信息

## 八、归档规则

### 8.1 归档前置条件

**可归档的项目**：状态为"已确认"

**不可归档的项目**：

- 待启动、进行中、待确认、已归档
- 待补录标记的项目：即使状态是"已确认"，如果标记为"待补录"，也应该先完成补录申请才能归档

### 8.2 归档流程

**归档申请流程**：

1. 点击"发起归档"按钮
2. 显示固定提示："请确定差旅和外包支出都已录入后再进行归档"
3. 显示财务指标（业绩金额、实际利润、实际利润率）
4. 填写归档说明（可选）
5. 提交后，归档申请状态为"pending"（待审批）

**归档审批流程**：

1. 审批人员查看归档申请
2. 金额核对：
   - 核对业绩金额
   - 核对实际人力支出、差旅支出、外包支出
   - 核对实际利润计算是否正确
   - 确认差旅和外包支出是否已录入
3. 审批通过后：
   - 根据实际的人力支出、差旅支出、外包支出，重新计算实际利润
   - 更新 `projectedProfit` 字段为实际利润（实际利润 = 业绩金额 - 实际人力支出 - 实际差旅支出 - 实际外包支出）
   - 项目状态变为"已归档"
   - 项目默认隐藏（不显示在列表中）
   - 可通过"显示归档项目"筛选显示

### 8.3 取消归档规则

**可取消归档的项目**：状态为"已归档"

**取消归档流程**：

- 点击"取消归档"按钮
- 不需要审批，直接取消归档
- 项目状态变为"已确认"
- 项目重新显示在列表中

## 八点五、阶段模板和阶段管理规则

### 8.5.1 阶段模板

**阶段模板说明**：

- 阶段模板用于定义项目的标准阶段和每个阶段占整体工作量的比例
- 系统提供默认模板，管理员可创建自定义模板
- 模板适用于项目制和计件制项目

**阶段模板字段**：

- `id`: 模板 ID
- `name`: 模板名称
- `type`: 适用类型（'project' | 'piecework'）
- `category`: 模板分类（可选）
- `stages`: 阶段列表（每个阶段包含名称和占比）
- `isSystem`: 是否系统模板
- `createdBy`: 创建人

**阶段模板项字段**：

- `id`: 阶段项 ID
- `name`: 阶段名称
- `percentage`: 占比（0-100，所有阶段占比之和必须等于 100）

### 8.5.2 项目阶段（实例化）

**项目阶段字段**：

- `id`: 阶段 ID
- `projectId`: 关联的项目 ID（项目制）或需求编号（计件制）
- `stageTemplateItemId`: 关联的模板阶段 ID（可选，用于追溯模板）
- `name`: 阶段名称（可编辑）
- `percentage`: 占比（可编辑，0-100）
- `status`: 阶段状态（'pending' | 'in_progress' | 'completed'）
- `completionPercentage`: 阶段完成百分比（0-100，仅在进行中状态时可设置）
- `completedAt`: 完成时间
- `completedBy`: 完成人 ID
- `completedByName`: 完成人姓名
- `attachmentUrl`: 完成附件（可选）

**业务规则**：

- 项目制和计件制项目立项时，必须选择阶段模板
- 选择模板后，自动创建项目阶段实例（可编辑阶段名称和占比）
- 所有阶段占比之和必须等于 100%
- 阶段可以随时标记为"进行中"或"完成"
- 阶段进行中时，可以设置阶段完成百分比（0-100），用于体现工作周期较长阶段的进度变化
- 阶段完成后，阶段完成百分比自动为 100%
- 项目进度自动计算：`进度 = sum(阶段.percentage × 阶段完成百分比 / 100)`
- 支持阶段回退（将已完成阶段标记为未完成，重新计算进度）

### 8.5.3 阶段完成规则

**完成权限**：

- 归属部门主管可以标记阶段完成和设置阶段完成百分比
- 项目经理可以标记阶段完成和设置阶段完成百分比

**阶段状态操作**：

- **标记为进行中**：勾选阶段为"进行中"状态
- **设置完成百分比**：阶段进行中时，可以设置完成百分比（0-100），用于体现工作周期较长阶段的进度变化
- **标记为完成**：勾选阶段为"完成"状态，阶段完成百分比自动为 100%
- **上传附件**：标记阶段完成时，可上传完成附件（可选）
- 系统自动记录完成时间和完成人
- 自动计算项目进度

**进度计算规则**：

- 阶段待开始（pending）：阶段完成百分比 = 0
- 阶段进行中（in_progress）：阶段完成百分比 = 设置的百分比（0-100）
- 阶段已完成（completed）：阶段完成百分比 = 100
- 项目进度 = sum(阶段.percentage × 阶段完成百分比 / 100)

**阶段回退**：

- 支持将已完成阶段标记为"进行中"或"待开始"
- 回退后，阶段完成百分比重置为 0（进行中）或保持当前值（可手动调整）
- 回退后重新计算项目进度
- 记录回退操作日志

### 8.5.4 阶段调整规则

**调整方式**：

- 阶段调整通过项目变更流程进行
- 可以调整阶段名称、占比、添加/删除阶段
- 调整后需验证：所有阶段占比之和 = 100%
- 调整后重新计算项目进度

## 九、进度更新规则

### 9.1 进度计算规则

**项目制/计件制**：

- 进度由阶段完成情况自动计算：`进度 = sum(阶段.percentage × 阶段完成百分比 / 100)`
- 进度范围：0-100（自动计算，无需手动填写）
- 到达计划开始日期时，项目状态自动变为"进行中"，实际开始日期自动设置为计划开始日期（或允许手动调整）
- 所有阶段完成后（所有阶段完成百分比 = 100），进度自动为 100%，可手动设置为"待确认"

**离岸制/驻场制**：

- 不使用阶段模板
- 进度字段不使用（或显示为"-"）
- 完成业绩通过业绩管理模块按月手动录入

### 9.2 进度更新操作

**更新方式**：

- 项目制/计件制：通过标记阶段完成和设置阶段完成百分比来更新进度（自动计算）
- 不再支持手动填写进度百分比

**阶段操作**：

- 可以随时标记阶段为"进行中"或"完成"
- 阶段进行中时，可以设置阶段完成百分比（0-100），用于体现工作周期较长阶段的进度变化
- 标记阶段完成时，阶段完成百分比自动为 100%，可上传附件（可选）
- 系统自动记录完成时间和完成人
- 自动计算项目进度：`进度 = sum(阶段.percentage × 阶段完成百分比 / 100)`

**进度达到 100%**：

- 所有阶段完成后（所有阶段完成百分比 = 100），进度自动为 100%
- 可手动设置为"待确认"状态

### 9.3 实际开始日期

**设置规则**：

- 到达计划开始日期时，系统自动将实际开始日期设置为计划开始日期
- 如果实际开始日期与计划开始日期不同，允许手动调整
- 实际开始日期一旦设置，不允许修改（除非通过项目变更流程）

### 9.4 工时数据

**工时来源**：

- 通过系统内的任务和工时管理模块录入
- 支持手动录入实际工时

**工时记录**：

- 通过任务关联到项目，记录实际工时
- 系统自动计算人力成本：`calculatedCost = hours / 8 * dailyCost`（工时 × 等级单价）

## 十、筛选和搜索规则

### 10.1 筛选规则

**项目类型筛选**：项目制、计件制、离岸制、驻场制、全部

**项目状态筛选**：待启动、进行中、待确认、已确认、已归档、全部

**待补录筛选**（独立筛选选项）：显示待补录项目（`isPendingEntry = true`）、显示非待补录项目、全部

**归属部门筛选**：体验一组、体验二组、体验三组、体验五组、核心业务拓展部、驻场服务部、全部

**显示归档项目**：默认不显示归档项目，勾选后显示归档项目

### 10.2 搜索规则

**搜索字段**：项目名称/需求名称、项目经理、商务经理

**搜索逻辑**：支持模糊匹配，不区分大小写

## 十一、业务约束规则

### 11.1 数据完整性约束

1. **项目 ID 唯一性**：每个项目必须有唯一的项目 ID
2. **计件项目关联**：计件制项目必须关联到计件项目
3. **预算完整性**：项目制/计件制项目必须录入人力预算（差旅和外包可选）
4. **日期逻辑**：计划结束日期必须晚于计划开始日期
5. **金额验证**：项目制/计件制创建时业绩金额必须 > 0，离岸制/驻场制创建时不录入业绩金额（业绩来源于业绩管理模块的累加）

### 11.2 状态约束

1. **已归档项目**：不能做变更、不能标记阶段完成、不能发起设计确认、不能补录申请
2. **待补录标记的项目**（`isPendingEntry = true`）：不能做变更，但可以标记阶段完成（状态可以是"待启动"、"进行中"、"待确认"、"已确认"）、可以发起设计确认（状态为"进行中"或"待确认"时）、可以补录申请
3. **已确认项目**：不能做变更，但可以标记阶段完成（因为部分情况下会有一些工作是要在设计确认后开展的，例如售后、维护等工作）
4. **离岸制/驻场制**：不需要录入预算，创建时不录入业绩金额和成本（业绩来源于业绩管理模块的累加），不需要显示财务汇总信息

### 11.3 操作权限约束

1. **项目变更**：只有非归档、非待补录标记的项目才能做变更
2. **设计确认**：进行中/待确认的项目可以发起设计确认（非离岸制/驻场制），待补录标记的项目如果状态是"进行中"或"待确认"也可以发起设计确认
3. **归档**：只有已确认的项目才能归档
4. **补录申请**：待补录标记的计件制项目可以提交补录申请（已归档除外）
5. **支出录入**：支出录入统一在成本管理模块中进行，项目详情页不提供支出录入功能
6. **标记阶段完成**：已确认状态下也可以标记阶段完成（因为部分情况下会有一些工作是要在设计确认后开展的，例如售后、维护等工作）

## 十二、交互设计

### 12.1 项目列表页

**列表显示字段**：项目名称/需求名称、项目类型、项目经理、归属部门、商务经理、客户部、计划开始/结束日期、项目状态、进度、业绩金额、财务汇总（预算/支出/利润）、操作按钮

**操作按钮显示规则**：

- 查看详情：所有项目
- 项目变更：非归档、非待补录标记的项目
- 补录申请：待补录标记的项目

### 12.2 项目详情页

**详情页标签**：基本信息、阶段管理（项目制/计件制）、预算明细、支出明细、财务汇总、变更记录、设计确认记录

**操作按钮显示规则**：

- 标记阶段完成：非归档项目（包括待补录标记的项目、已确认），项目制/计件制项目
- 设置阶段完成百分比：阶段进行中时，可以设置完成百分比（0-100）
- 发起设计确认：进行中/待确认、非离岸制/驻场制项目（待补录标记的项目如果状态是"进行中"或"待确认"也可以发起）
- 发起归档：已确认项目
- 取消归档：已归档项目
- 提交补录申请：待补录标记的项目（已归档除外）
- 项目变更：非归档、非待补录标记的项目

**阶段管理区域**（项目制/计件制）：

- 显示所有阶段列表，每个阶段显示：阶段名称、占比、状态、完成百分比（进行中时显示）
- 阶段状态操作：可以标记为"进行中"或"完成"
- 阶段完成百分比设置：阶段进行中时，可以设置完成百分比（0-100），使用滑块或输入框
- 阶段完成附件：标记阶段完成时，可上传附件（可选）
- 进度显示：实时显示项目总进度（自动计算）

### 12.3 表单交互

**响应式布局**：

- 使用 Arco Design Grid 系统
- 断点：xs(24 列)、sm(12 列)、md(12 列)、lg(6 列)、xl(6 列)、xxl(6 列)
- 一行最多 4 列录入组件（lg 及以上）

**字段布局**：

- 标题和输入框左右布局（标题在左，输入框在右）
- 标题最小宽度：98px
- 输入框下边距：8px

**验证反馈**：

- 实时验证：输入时显示错误提示
- 提交验证：提交时验证所有必填项
- 错误提示：显示在输入框下方，红色文字

## 十三、权限控制规则

### 13.1 项目创建权限

**创建权限**：

- 所有用户都可以发起立项申请（创建项目）
- 立项申请需要审批（根据项目类型和金额确定审批流程）

### 13.2 项目编辑权限

**说明**：项目编辑功能已取消，项目信息修改需通过项目变更流程进行。项目变更权限遵循项目变更规则。

### 13.3 项目删除权限

**删除权限**：

- 归属部门主管可以删除该部门的项目（建议软删除，保留历史记录）

### 13.4 项目查看权限

**查看权限**：

- 所有用户都可以查看项目列表和详情
- 可以根据部门权限限制查看范围

## 十四、总结

商业项目模块的核心逻辑是：

1. **项目创建**：根据项目类型（项目制/计件制/离岸制/驻场制）展示不同的表单和验证规则，项目制/计件制必须选择阶段模板
2. **阶段管理**：项目制/计件制使用阶段模板，通过标记阶段完成和设置阶段完成百分比自动计算进度，完成业绩 = 进度 × 业绩金额
3. **预算管理**：项目制/计件制必须录入预算（人力预算必填，差旅和外包可选），离岸制/驻场制不需要预算，也不需要展示财务汇总信息
4. **状态流转**：待启动 → 进行中（到达计划开始日期自动触发） → 待确认 → 已确认 → 已归档
5. **项目变更**：支持项目信息、预算和阶段的变更，需要审批
6. **补录申请**：计件制项目支持补录预算和业绩（待补录是标记字段，不是状态）
7. **设计确认**：进行中/待确认项目可以发起设计确认
8. **归档管理**：已确认项目可以归档，归档时需要核对预算与支出，归档时根据实际支出重新计算实际利润，归档后可以取消归档

主要特点：

1. 不同类型项目有不同的业务规则和表单验证
2. 项目制/计件制使用阶段模板，进度自动计算，完成业绩自动计算
3. 预算管理支持人力、差旅、外包三种类型；支出数据来源于任务和工时管理模块（人力支出）和成本管理模块（差旅和外包支出），项目详情页仅提供查看功能
4. 状态流转有明确的前置条件和约束，到达计划开始日期自动变为"进行中"
5. 支持项目变更和补录申请，需要审批流程
6. 财务统计自动计算预算、支出、利润等信息
7. 归档时进行预算与支出核对，并根据实际支出重新计算实际利润（实时利润）
8. 所有用户都可以发起立项申请，需要审批
