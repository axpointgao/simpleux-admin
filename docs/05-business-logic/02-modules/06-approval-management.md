# 审批管理模块业务逻辑规则

## 一、数据模型

### 1.1 核心实体

#### Approval（审批）

**审批类型（`type`）**：
- `project_create`：项目创建
- `project_change`：项目变更
- `project_post_record`：项目补录
- `expense_travel`：差旅费用
- `expense_outsource`：外包费用
- `design_confirm`：设计确认
- `contribution_create`：专业贡献立项
- `contribution_acceptance`：专业贡献验收
- `performance_acceptance`：业绩验收

**审批状态（`status`）**：
- `pending`：审批中
- `approved`：已通过
- `rejected`：已拒绝
- `cancelled`：已取消

**核心字段**：
- `id`：审批ID（唯一标识）
- `type`：审批类型（必填）
- `relatedId`：关联业务实体ID（必填）
- `relatedType`：关联业务实体类型（必填：'project' | 'opportunity' | 'contribution' | 'expense' | 'performance'）
- `title`：审批标题（必填）
- `description`：审批说明（可选）
- `applicantId`：申请人ID（必填）
- `applicantName`：申请人姓名
- `status`：审批状态（默认：'pending'）
- `currentStepIndex`：当前审批步骤索引（从0开始）
- `currentStepId`：当前审批步骤ID
- `dingtalkTaskId`：钉钉待办任务ID（可选，用于钉钉待办集成）
- `createdAt`：创建时间
- `updatedAt`：更新时间
- `completedAt`：完成时间（审批通过或拒绝时）

**业务规则**：
- 审批创建后，状态默认为"审批中"（`pending`）
- 审批流程根据审批类型查找对应的审批流程模板
- 审批流程支持多步骤审批，按步骤顺序执行
- 每个步骤有对应的审批人，审批人可以是具体用户或角色
- 当前步骤审批通过后，自动进入下一步骤
- 所有步骤审批通过后，审批状态变为"已通过"
- 任意步骤审批拒绝后，审批状态变为"已拒绝"
- 申请人可以取消审批（状态变为"已取消"）
- 系统内完成审批后，调用钉钉API更新待办任务状态

#### ApprovalStep（审批步骤）

**步骤状态（`stepStatus`）**：
- `pending`：待审批
- `approved`：已通过
- `rejected`：已拒绝

**核心字段**：
- `id`：审批步骤ID（唯一标识）
- `approvalId`：关联的审批ID（必填）
- `stepIndex`：步骤索引（从0开始，必填）
- `stepName`：步骤名称（必填）
- `approverId`：审批人ID（必填，可以是具体用户或角色）
- `approverName`：审批人姓名
- `approverType`：审批人类型（'user' | 'role'，必填）
- `stepStatus`：步骤状态（默认：'pending'）
- `comment`：审批意见（可选）
- `approvedAt`：审批时间
- `dingtalkTaskId`：钉钉待办任务ID（可选，用于钉钉待办集成）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 审批步骤按顺序执行，从索引0开始
- 每个步骤有对应的审批人，审批人可以是具体用户或角色
- 如果审批人类型是角色，需要根据角色查找对应的用户
- 步骤状态为"待审批"时，审批人可以审批
- 步骤审批通过后，状态变为"已通过"，自动进入下一步骤
- 步骤审批拒绝后，状态变为"已拒绝"，整个审批流程终止
- 系统内完成审批后，调用钉钉API更新待办任务状态

#### ApprovalHistory（审批历史）

**操作类型（`action`）**：
- `create`：创建审批
- `approve`：审批通过
- `reject`：审批拒绝
- `cancel`：取消审批
- `submit`：提交审批

**核心字段**：
- `id`：审批历史ID（唯一标识）
- `approvalId`：关联的审批ID（必填）
- `stepId`：关联的审批步骤ID（可选）
- `action`：操作类型（必填）
- `operatorId`：操作人ID（必填）
- `operatorName`：操作人姓名
- `comment`：操作说明（可选）
- `createdAt`：创建时间

**业务规则**：
- 每次审批操作都会创建一条审批历史记录
- 审批历史记录不可修改、不可删除（只读）
- 审批历史用于记录审批流程的完整操作记录

#### ApprovalAttachment（审批附件）

**核心字段**：
- `id`：审批附件ID（唯一标识）
- `approvalId`：关联的审批ID（必填）
- `stepId`：关联的审批步骤ID（可选）
- `fileName`：文件名（必填）
- `fileUrl`：文件URL（必填）
- `fileSize`：文件大小（可选，字节）
- `fileType`：文件类型（可选）
- `uploadedBy`：上传人ID（必填）
- `uploadedByName`：上传人姓名
- `createdAt`：创建时间

**业务规则**：
- 审批附件可以关联到审批或审批步骤
- 审批附件支持多种文件类型（图片、文档、压缩包等）
- 审批附件可以删除（由上传人或具有权限的用户操作）

## 二、审批流程

### 2.1 审批创建流程

**业务流程**：
1. 用户在业务模块（项目、专业贡献、业绩等）提交审批申请
2. 系统根据审批类型查找对应的审批流程模板
3. 创建审批记录（`status = 'pending'`）
4. 根据审批流程模板创建审批步骤记录
5. 为当前步骤的审批人创建钉钉待办任务：
   - 调用钉钉API创建待办任务
   - 设置待办标题、内容、跳转链接（系统内审批页面URL，包含审批ID参数）
   - 设置待办接收人（当前步骤的审批人）
   - 获取钉钉待办任务ID（`dingtalkTaskId`），保存到审批步骤记录和审批记录中
6. 发送钉钉工作通知给当前步骤的审批人
7. 记录审批历史（action = 'create'）

**业务规则**：
- 审批类型必须对应一个启用的审批流程模板
- 审批步骤根据模板自动创建
- 审批人根据审批流程模板配置自动确定
- 创建审批后，自动为当前步骤的审批人创建钉钉待办任务并发送通知
- 钉钉待办任务包含跳转链接，点击后跳转到系统内审批详情页

### 2.2 审批执行流程

**业务流程**：
1. 审批人收到钉钉工作通知，点击通知
2. 跳转到系统内审批详情页（通过URL参数传递审批ID）
3. 查看审批信息和关联的业务实体信息（完整的审批详细内容）
4. 填写审批意见（可选）
5. 选择审批操作（通过/拒绝）
6. 提交审批
7. 更新审批步骤状态（approved/rejected）
8. 调用钉钉API更新当前步骤的待办任务状态为"已完成"
9. 判断是否所有必审步骤已完成
10. 如果已完成，更新审批记录状态（approved/rejected）
11. 如果未完成，进入下一步骤：
    - 为下一步骤的审批人创建钉钉待办任务
    - 发送钉钉工作通知给下一步骤的审批人
12. 记录审批历史（action = 'approve'/'reject'）
13. 发送通知给申请人（审批通过/拒绝）

**业务规则**：
- 审批操作在系统内完成，钉钉只用于发送通知和创建待办任务
- 审批人必须在系统内审批详情页查看完整的审批内容
- 审批通过后，自动进入下一步骤（如果有）
- 审批拒绝后，整个审批流程终止
- 所有必审步骤通过后，审批状态自动变为"已通过"
- 任意必审步骤拒绝后，审批状态自动变为"已拒绝"
- 系统内审批完成后，调用钉钉API更新待办任务状态

### 2.3 审批取消流程

**业务流程**：
1. 申请人在审批列表或详情页点击"取消审批"
2. 系统验证：审批状态必须是"审批中"（pending）
3. 确认取消
4. 更新审批记录状态为"已取消"（cancelled）
5. 调用钉钉API更新当前步骤的待办任务状态为"已完成"（如果存在）
6. 记录审批历史（action = 'cancel'）

**业务规则**：
- 只有申请人可以取消审批
- 只有状态为"审批中"的审批可以取消
- 取消审批后，审批流程终止
- 取消审批后，调用钉钉API更新待办任务状态

### 2.4 审批流程规则

**步骤执行规则**：
- 审批步骤按顺序执行，从索引0开始
- 每个步骤有对应的审批人，审批人可以是具体用户或角色
- 如果审批人类型是角色，需要根据角色查找对应的用户
- 当前步骤审批通过后，自动进入下一步骤
- 当前步骤审批拒绝后，整个审批流程终止
- 所有必审步骤通过后，审批状态自动变为"已通过"
- 任意必审步骤拒绝后，审批状态自动变为"已拒绝"

**审批人确定规则**：
- 根据审批流程模板配置确定审批人
- 审批人可以是具体用户（`approverType = 'user'`）
- 审批人可以是角色（`approverType = 'role'`），需要根据角色查找对应的用户
- 如果审批人类型是角色，需要根据业务实体（如项目、专业贡献）的归属部门确定具体的审批人

## 三、审批列表

### 3.1 列表分类

**待审批列表**：
- 显示当前用户需要审批的审批记录
- 筛选条件：审批类型、关联业务实体类型、创建时间
- 排序：默认按创建时间倒序（最新的在前）
- 显示字段：审批标题、审批类型、申请人、创建时间、当前步骤

**已审批列表**：
- 显示当前用户已审批过的审批记录
- 筛选条件：审批类型、审批状态、审批时间
- 排序：默认按审批时间倒序
- 显示字段：审批标题、审批类型、申请人、审批状态、审批时间、审批意见

**我发起的列表**：
- 显示当前用户发起的审批记录
- 筛选条件：审批类型、审批状态、创建时间
- 排序：默认按创建时间倒序
- 显示字段：审批标题、审批类型、审批状态、当前步骤、创建时间、完成时间

### 3.2 列表筛选

**筛选条件**：
- **审批类型**：下拉选择（多选），如项目创建、项目变更、专业贡献立项等
- **审批状态**：下拉选择（多选），如待审批、已通过、已拒绝等
- **关联业务实体类型**：下拉选择（多选），如项目、专业贡献、业绩等
- **创建时间**：日期范围选择器
- **申请人**：下拉选择（多选）
- **审批人**：下拉选择（多选，用于已审批列表）

**筛选逻辑**：
- 所有筛选条件都是"且"的关系（AND）
- 支持多个筛选条件组合
- 筛选条件改变时，列表自动更新

### 3.3 列表操作

**批量操作**：
- 批量导出（所有列表）

**单个操作**：
- 查看详情：跳转到审批详情页
- 审批操作：待审批列表中，点击"审批"按钮
- 取消审批：我发起的列表中，待审批状态可以取消

## 四、审批详情页

### 4.1 页面布局

**基本信息区域**：
- 审批标题
- 审批类型
- 审批状态
- 申请人
- 创建时间
- 完成时间（如果已完成）

**审批流程区域**：
- 显示审批流程步骤（可视化流程图）
- 显示每个步骤的状态（待审批/已通过/已拒绝）
- 显示每个步骤的审批人和审批时间
- 显示每个步骤的审批意见

**审批内容区域**：
- 显示关联的业务实体信息（根据relatedType和relatedId获取）
- 显示审批说明
- 显示审批附件

**审批操作区域**：
- 审批操作按钮（通过/拒绝，仅当前步骤审批人可见）
- 取消审批按钮（仅申请人可见，且状态为pending）

### 4.2 审批操作

**审批通过**：
1. 当前步骤审批人点击"通过"按钮
2. 填写审批意见（可选）
3. 提交审批
4. 更新审批步骤状态为"已通过"
5. 调用钉钉API更新当前步骤的待办任务状态为"已完成"
6. 判断是否所有必审步骤已完成
7. 如果已完成，更新审批记录状态为"已通过"
8. 如果未完成，进入下一步骤，为下一步骤的审批人创建钉钉待办任务并发送通知
9. 记录审批历史
10. 发送通知给申请人（如果审批已完成）

**审批拒绝**：
1. 当前步骤审批人点击"拒绝"按钮
2. 填写审批意见（必填，说明拒绝原因）
3. 提交审批
4. 更新审批步骤状态为"已拒绝"
5. 更新审批记录状态为"已拒绝"
6. 调用钉钉API更新当前步骤的待办任务状态为"已完成"
7. 记录审批历史
8. 发送通知给申请人

**取消审批**：
1. 申请人点击"取消审批"按钮
2. 确认取消
3. 更新审批记录状态为"已取消"
4. 调用钉钉API更新当前步骤的待办任务状态为"已完成"（如果存在）
5. 记录审批历史
6. 发送通知给当前步骤的审批人（如果存在）

### 4.3 审批历史

**显示内容**：
- 操作类型（创建、审批通过、审批拒绝、取消）
- 操作人
- 操作时间
- 操作说明（审批意见等）

**显示规则**：
- 按时间倒序排列（最新的在前）
- 显示完整的审批流程操作记录

## 五、钉钉待办集成

### 5.1 钉钉待办通知

**集成策略**：
- 审批流程在系统内完成，钉钉只用于发送通知和创建待办任务
- 审批人收到钉钉通知后，点击跳转到系统内审批详情页
- 系统内审批完成后，调用钉钉API更新待办任务状态

**创建待办任务流程**：
1. 创建审批时，根据审批类型查找对应的审批流程模板
2. 在系统内创建审批记录和审批步骤记录
3. 为当前步骤的审批人创建钉钉待办任务：
   - 调用钉钉API创建待办任务
   - 设置待办标题（审批标题）
   - 设置待办内容（审批说明）
   - 设置跳转链接（系统内审批详情页URL，包含审批ID参数）
   - 设置待办接收人（当前步骤的审批人，需要转换为钉钉用户ID）
   - 获取钉钉待办任务ID（`dingtalkTaskId`），保存到审批步骤记录和审批记录中
4. 发送钉钉工作通知给当前步骤的审批人

**业务规则**：
- 钉钉待办任务包含跳转链接，点击后跳转到系统内审批详情页
- 系统内审批详情页显示完整的审批内容和关联业务实体信息
- 审批人必须在系统内审批详情页查看完整的审批内容并进行审批操作

### 5.2 钉钉待办状态同步

**状态同步流程**：
1. 审批人在系统内审批详情页进行审批操作（通过/拒绝）
2. 系统更新审批步骤状态和审批记录状态
3. 调用钉钉API更新当前步骤的待办任务状态为"已完成"
4. 如果审批已完成（通过或拒绝），更新所有相关待办任务状态
5. 如果审批未完成，为下一步骤的审批人创建新的待办任务

**状态同步规则**：
- 审批通过后，调用钉钉API更新当前步骤的待办任务状态为"已完成"
- 审批拒绝后，调用钉钉API更新当前步骤的待办任务状态为"已完成"
- 审批取消后，调用钉钉API更新当前步骤的待办任务状态为"已完成"（如果存在）
- 进入下一步骤时，为下一步骤的审批人创建新的待办任务

**错误处理**：
- 如果钉钉API调用失败，记录错误日志，但不影响系统内审批流程
- 支持手动重试同步待办任务状态
- 支持查看待办任务同步状态

### 5.3 钉钉用户映射

**用户映射规则**：
- 系统用户通过`dingtalk_user_id`字段关联钉钉用户
- 创建待办任务时，需要将系统用户ID转换为钉钉用户ID
- 如果系统用户没有关联钉钉用户ID，则无法创建待办任务（记录错误日志）

**业务规则**：
- 系统用户必须关联钉钉用户ID才能接收待办任务
- 如果审批人没有关联钉钉用户ID，系统记录错误日志，但不影响审批流程
- 支持手动同步用户映射关系

## 六、交互设计

### 6.1 审批列表页

**页面布局**：
- **顶部**：标签页（待审批、已审批、我发起的）
- **筛选区域**：筛选条件输入框和按钮
- **列表区域**：审批列表表格
- **操作区域**：批量操作按钮

**列表字段**：
- 审批标题
- 审批类型
- 申请人（我发起的列表不显示）
- 审批状态
- 当前步骤（待审批列表显示）
- 创建时间
- 完成时间（已完成的审批显示）
- 操作按钮（查看详情、审批、取消等）

**状态标识**：
- 待审批：蓝色标签
- 已通过：绿色标签
- 已拒绝：红色标签
- 已取消：灰色标签

### 6.2 审批详情页

**页面布局**：
- **基本信息区域**：审批标题、类型、状态、申请人、时间等
- **审批流程区域**：可视化流程图
- **审批内容区域**：关联业务实体信息、审批说明、附件
- **审批操作区域**：审批操作按钮（通过/拒绝）
- **审批历史区域**：审批历史记录列表

**审批流程可视化**：
- 横向流程图，显示所有审批步骤
- 步骤状态用不同颜色标识（待审批：灰色，已通过：绿色，已拒绝：红色）
- 当前步骤高亮显示（蓝色）
- 点击步骤可以查看详细信息（审批人、审批时间、审批意见）

### 6.3 审批操作弹窗

**审批通过弹窗**：
- 审批信息（只读）：审批标题、类型、申请人、当前步骤
- 关联业务实体信息（只读）：显示关联的业务实体基本信息
- 审批意见（可选，文本域）
- 操作按钮：通过、取消

**审批拒绝弹窗**：
- 审批信息（只读）
- 关联业务实体信息（只读）
- 拒绝原因（必填，文本域）
- 操作按钮：拒绝、取消

## 七、权限控制规则

### 7.1 审批查看权限

**待审批列表**：
- 只能查看需要自己审批的审批记录
- 根据当前步骤的审批人过滤

**已审批列表**：
- 只能查看自己已审批过的审批记录
- 根据审批历史记录过滤

**我发起的列表**：
- 只能查看自己发起的审批记录
- 根据申请人过滤

### 7.2 审批操作权限

**审批操作权限**：
- 只有当前步骤的审批人才能进行审批操作（通过/拒绝）
- 系统验证当前用户是否为当前步骤的审批人

**取消审批权限**：
- 只有申请人可以取消审批
- 只有状态为"审批中"的审批可以取消

### 7.3 审批详情查看权限

**查看权限**：
- 申请人可以查看自己发起的审批详情
- 审批人可以查看自己需要审批或已审批的审批详情
- 系统管理员可以查看所有审批详情

**业务规则**：
- 审批详情页显示完整的审批内容和关联业务实体信息
- 审批人必须在系统内审批详情页查看完整的审批内容并进行审批操作

## 八、总结

审批管理模块的核心逻辑是：
1. **审批创建**：根据审批类型查找对应的审批流程模板，创建审批记录和审批步骤记录，为当前步骤的审批人创建钉钉待办任务并发送通知
2. **审批执行**：审批人在系统内审批详情页查看完整的审批内容，进行审批操作（通过/拒绝），系统内审批完成后调用钉钉API更新待办任务状态
3. **审批流程**：审批步骤按顺序执行，当前步骤审批通过后自动进入下一步骤，审批拒绝后整个审批流程终止
4. **钉钉集成**：审批流程在系统内完成，钉钉只用于发送通知和创建待办任务，点击钉钉通知跳转到系统内审批详情页

主要特点：
1. 审批流程在系统内完成，可以展示完整的审批详细内容
2. 钉钉只用于发送通知和创建待办任务，点击通知跳转到系统内审批详情页
3. 系统内审批完成后，调用钉钉API更新待办任务状态为"已完成"
4. 支持多步骤审批，按步骤顺序执行
5. 支持审批人类型为具体用户或角色
6. 支持审批历史记录，完整追踪审批流程
7. 支持审批附件，便于上传相关文件
8. 支持审批取消，申请人可以取消待审批的审批

