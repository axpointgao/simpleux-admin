# 审批管理模块功能需求

## 一、功能概述

审批管理模块用于集中管理所有业务模块的审批流程，包括审批创建、审批执行、审批列表、审批详情、钉钉待办集成等功能。

## 二、功能列表

### 2.1 审批创建

**功能描述**：
- 系统根据业务模块的审批申请自动创建审批记录
- 审批流程根据审批类型查找对应的审批流程模板
- 创建审批后，自动为当前步骤的审批人创建钉钉待办任务并发送通知

**功能要求**：

1. **审批类型**：
   - `project_create`：项目创建
   - `project_change`：项目变更
   - `project_post_record`：项目补录
   - `expense_travel`：差旅费用
   - `expense_outsource`：外包费用
   - `design_confirm`：设计确认
   - `contribution_create`：专业贡献立项
   - `contribution_acceptance`：专业贡献验收
   - `performance_acceptance`：业绩验收

2. **审批创建流程**：
   - 用户在业务模块提交审批申请
   - 系统根据审批类型查找对应的审批流程模板
   - 创建审批记录（`status = 'pending'`）
   - 根据审批流程模板创建审批步骤记录
   - 为当前步骤的审批人创建钉钉待办任务
   - 发送钉钉工作通知给当前步骤的审批人

3. **审批步骤配置**：
   - 审批步骤按索引顺序执行
   - 每个步骤有对应的审批人（可以是具体用户或角色）
   - 如果审批人类型是角色，需要根据业务实体的归属部门确定具体的审批人

**交互设计**：
- 审批创建由系统自动完成
- 用户只需在业务模块提交审批申请
- 创建成功后，显示审批ID和当前步骤

### 2.2 审批列表

**功能描述**：
- 显示审批列表，支持待审批、已审批、我发起的等分类
- 支持多维度筛选和搜索
- 支持排序和分页

**功能要求**：

1. **列表分类**：
   - **待审批列表**：显示当前用户需要审批的审批记录
   - **已审批列表**：显示当前用户已审批过的审批记录
   - **我发起的列表**：显示当前用户发起的审批记录

2. **列表字段**：
   - 审批标题
   - 审批类型
   - 申请人（我发起的列表不显示）
   - 审批状态
   - 当前步骤（待审批列表显示）
   - 创建时间
   - 完成时间（已完成的审批显示）
   - 操作按钮（查看详情、审批、取消等）

3. **筛选条件**：
   - 审批类型（下拉选择，多选）
   - 审批状态（下拉选择，多选）
   - 关联业务实体类型（下拉选择，多选）
   - 创建时间（日期范围选择器）
   - 申请人（下拉选择，多选）
   - 审批人（下拉选择，多选，用于已审批列表）

4. **排序**：
   - 默认按创建时间倒序
   - 支持按审批状态、创建时间等字段排序

5. **分页**：
   - 每页显示20条记录
   - 支持跳转到指定页码

**交互设计**：
- 列表使用标签页组织（待审批、已审批、我发起的）
- 筛选条件在列表顶部，支持展开/收起
- 支持批量操作（如批量导出）

### 2.3 审批详情

**功能描述**：
- 显示审批的完整信息
- 支持审批操作（通过/拒绝）
- 支持查看审批流程、审批历史等

**功能要求**：

1. **基本信息区域**：
   - 审批标题、审批类型、审批状态
   - 申请人、创建时间、完成时间
   - 操作按钮（审批、取消等）

2. **审批流程区域**：
   - 显示审批流程步骤（可视化流程图）
   - 显示每个步骤的状态（待审批/已通过/已拒绝）
   - 显示每个步骤的审批人和审批时间
   - 显示每个步骤的审批意见
   - 当前步骤高亮显示

3. **审批内容区域**：
   - 显示关联的业务实体信息（根据`relatedType`和`relatedId`获取）
   - 显示审批说明
   - 显示审批附件
   - 支持跳转到关联业务实体的详情页

4. **审批操作区域**：
   - 审批操作按钮（通过/拒绝，仅当前步骤审批人可见）
   - 取消审批按钮（仅申请人可见，且状态为pending）
   - 查看历史按钮

5. **审批历史区域**：
   - 显示所有审批历史记录
   - 操作类型、操作人、操作时间、操作说明
   - 按时间倒序排列

**交互设计**：
- 使用标签页组织不同区域的内容
- 审批流程使用可视化流程图展示
- 支持展开/收起各个区域

### 2.4 审批操作

**功能描述**：
- 支持审批通过、审批拒绝、取消审批等操作
- 审批操作在系统内完成
- 审批完成后，调用钉钉API更新待办任务状态

**功能要求**：

1. **审批通过**：
   - 当前步骤审批人点击"通过"按钮
   - 填写审批意见（可选）
   - 提交审批
   - 更新审批步骤状态为"已通过"
   - 调用钉钉API更新当前步骤的待办任务状态为"已完成"
   - 判断是否所有必审步骤已完成
   - 如果已完成，更新审批记录状态为"已通过"
   - 如果未完成，进入下一步骤，为下一步骤的审批人创建钉钉待办任务并发送通知
   - 记录审批历史

2. **审批拒绝**：
   - 当前步骤审批人点击"拒绝"按钮
   - 填写拒绝原因（必填）
   - 提交审批
   - 更新审批步骤状态为"已拒绝"
   - 更新审批记录状态为"已拒绝"
   - 调用钉钉API更新当前步骤的待办任务状态为"已完成"
   - 记录审批历史
   - 发送通知给申请人

3. **取消审批**：
   - 申请人点击"取消审批"按钮
   - 确认取消
   - 更新审批记录状态为"已取消"
   - 调用钉钉API更新当前步骤的待办任务状态为"已完成"（如果存在）
   - 记录审批历史

**交互设计**：
- 审批操作使用弹窗
- 审批通过弹窗：显示审批信息，填写审批意见（可选）
- 审批拒绝弹窗：显示审批信息，填写拒绝原因（必填）
- 取消审批：使用确认对话框

### 2.5 钉钉待办集成

**功能描述**：
- 审批流程在系统内完成，钉钉只用于发送通知和创建待办任务
- 审批人收到钉钉通知后，点击跳转到系统内审批详情页
- 系统内审批完成后，调用钉钉API更新待办任务状态

**功能要求**：

1. **创建待办任务**：
   - 创建审批时，为当前步骤的审批人创建钉钉待办任务
   - 设置待办标题（审批标题）
   - 设置待办内容（审批说明）
   - 设置跳转链接（系统内审批详情页URL，包含审批ID参数）
   - 设置待办接收人（当前步骤的审批人，需要转换为钉钉用户ID）
   - 获取钉钉待办任务ID，保存到审批步骤记录和审批记录中
   - 发送钉钉工作通知给当前步骤的审批人

2. **状态同步**：
   - 审批通过后，调用钉钉API更新当前步骤的待办任务状态为"已完成"
   - 审批拒绝后，调用钉钉API更新当前步骤的待办任务状态为"已完成"
   - 审批取消后，调用钉钉API更新当前步骤的待办任务状态为"已完成"（如果存在）
   - 进入下一步骤时，为下一步骤的审批人创建新的待办任务

3. **用户映射**：
   - 系统用户通过`dingtalk_user_id`字段关联钉钉用户
   - 创建待办任务时，需要将系统用户ID转换为钉钉用户ID
   - 如果系统用户没有关联钉钉用户ID，则无法创建待办任务（记录错误日志）

**交互设计**：
- 钉钉集成由系统自动完成
- 用户无需手动操作
- 支持查看待办任务同步状态

## 三、功能优先级

### 3.1 P0（必须实现）

- 审批创建
- 审批列表
- 审批详情
- 审批操作（通过/拒绝/取消）
- 钉钉待办集成

### 3.2 P1（重要功能）

- 审批流程可视化
- 审批历史记录
- 批量操作

### 3.3 P2（可选功能）

- 审批统计
- 审批报表
- 审批导出

## 四、验收标准

### 4.1 功能验收

- 所有P0功能必须完整实现
- 所有P1功能必须完整实现
- 功能符合业务逻辑规则文档要求
- 审批流程正确执行
- 钉钉待办集成正确实现

### 4.2 性能验收

- 审批列表加载时间 < 2秒
- 审批详情加载时间 < 1秒
- 审批操作响应时间 < 1秒
- 钉钉API调用响应时间 < 2秒

### 4.3 用户体验验收

- 界面友好，操作流畅
- 错误提示清晰
- 支持响应式设计
- 审批流程可视化清晰
- 钉钉通知跳转正确

