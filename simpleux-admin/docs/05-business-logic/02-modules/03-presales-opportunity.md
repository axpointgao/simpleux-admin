# 售前支持模块业务逻辑规则

## 一、数据模型

### 1.1 核心实体

#### Opportunity（售前支持/商机）

**商机状态（`status`）**：
- `进行中`（IN_PROGRESS）：商机正在进行中
- `赢单`（WON）：商机已成功，转为项目
- `输单`（LOST）：商机失败，未获得项目
- `沉默`（SILENT）：商机暂时无进展，处于沉默状态
- `放弃`（ABANDONED）：主动放弃该商机

**商机等级（`level`）**：
- `A`：高优先级商机
- `B`：中优先级商机
- `C`：低优先级商机
- 可为空（未设置等级）

**赢单概率（`winRate`）**：
- `High`：高概率
- `Medium`：中概率
- `Low`：低概率
- 可为空（未设置概率）

**支持类型（`supportTypes`）**：
- `评估报价`：提供评估和报价服务
- `投标配合`：配合投标工作
- `POC方案`：提供概念验证方案
- `交流分享`：进行交流分享活动
- 支持多选（一个商机可以有多种支持类型）

**核心字段**：
- `id`：商机ID（唯一标识）
- `code`：商机编号（自动生成，格式：OPP-YYYY-XXX，不在UI中显示）
- `name`：商机名称（必填）
- `level`：商机等级（可选，A/B/C）
- `status`：商机状态
- `winRate`：赢单概率（可选，High/Medium/Low）
- `estimatedAmount`：预估金额（可选，单位：万元）
- `supportTypes`：支持类型（数组，必填，至少选择一种）
- `owner`：负责人（必填，姓名）
- `group`：归属部门（Department枚举，必填）
- `bizManager`：商务经理（可选，姓名）
- `clientDept`：归属客户部（ClientDepartment枚举，可选）
- `createDate`：创建日期（必填，格式：YYYY-MM）
- `description`：备注/说明（可选）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**成本统计字段（`costStats`）**：
- `totalCost`：总支出
- `laborCost`：人力成本（来源于关联的任务和工时记录）
- `travelCost`：差旅成本（来源于手动录入的差旅支出）
- `outsourceCost`：外包成本（来源于手动录入的外包支出）

**关联关系**：
- 一个商机可以关联多个任务（通过任务管理模块，用于人力成本计算）
- 一个商机可以有多条差旅支出记录（手动录入）
- 一个商机可以有多条外包支出记录（手动录入）
- 一个商机可以有多条跟进记录
- 赢单后可以转为商业项目

#### OpportunityFollowUp（跟进记录）

**核心字段**：
- `id`：跟进记录ID（唯一标识）
- `opportunityId`：关联的商机ID（必填）
- `followUpDate`：跟进日期（必填，格式：YYYY-MM-DD）
- `status`：跟进时的商机状态（必填）
- `winRate`：跟进时的赢单概率（可选）
- `estimatedAmount`：跟进时的预估金额（可选）
- `supportTypes`：跟进时的支持类型（数组，可选）
- `note`：跟进备注（必填）
- `operatorId`：操作人ID（必填）
- `operatorName`：操作人姓名
- `createdAt`：创建时间

**业务规则**：
- 每次跟进都会创建一条跟进记录
- 跟进记录用于追踪商机的状态变化历史
- 跟进记录不可修改、不可删除（只读）

#### OpportunityTravelExpense（差旅支出记录）

**核心字段**：
- `id`：差旅支出记录ID（唯一标识）
- `opportunityId`：关联的商机ID（必填）
- `expenseMonth`：统计月份（必填，格式：YYYY-MM）
- `item`：出差事项（必填）
- `transportBig`：大交通费用（可选，单位：元）
- `stay`：住宿费用（可选，单位：元）
- `transportSmall`：小交通费用（可选，单位：元）
- `allowance`：补助费用（可选，单位：元）
- `other`：其他费用（可选，单位：元）
- `totalAmount`：总金额（自动计算：各项费用之和）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 差旅支出由专人手动录入，关联到商机
- 至少填写一项费用（大交通、住宿、小交通、补助、其他）
- 总金额自动计算：各项费用之和

#### OpportunityOutsourceExpense（外包支出记录）

**核心字段**：
- `id`：外包支出记录ID（唯一标识）
- `opportunityId`：关联的商机ID（必填）
- `expenseMonth`：统计月份（必填，格式：YYYY-MM）
- `item`：外包事项（必填）
- `vendor`：供应商（必填）
- `amount`：金额（必填，必须 > 0，单位：元）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 外包支出由专人手动录入，关联到商机
- 金额必须 > 0

## 二、商机创建规则

### 2.1 创建流程

**业务流程**：
1. 主管在售前支持列表页点击"创建商机"
2. 填写商机基本信息：商机名称、负责人、归属部门、支持类型等
3. 可选填写：商机等级、赢单概率、预估金额、商务经理、客户部、备注
4. 提交后创建商机，状态默认为"进行中"

**必填字段**：
- 商机名称：必填，不能为空
- 负责人：必填，必须从员工列表中选择
- 归属部门：必填，必须选择
- 支持类型：必填，至少选择一种
- 创建日期：必填，默认为当前月份

**可选字段**：
- 商机等级：可选，A/B/C
- 赢单概率：可选，High/Medium/Low
- 预估金额：可选，单位：万元，支持小数
- 商务经理：可选，文本输入
- 客户部：可选，从客户部枚举中选择
- 备注：可选，文本输入

### 2.2 表单验证规则

**通用验证**：
- 商机名称：必填，不能为空，长度限制（建议不超过100字符）
- 负责人：必填，必须从员工列表中选择
- 归属部门：必填，必须选择
- 支持类型：必填，至少选择一种
- 创建日期：必填，格式：YYYY-MM

**可选字段验证**：
- 预估金额：如果填写，必须 >= 0，支持小数
- 商机等级：如果选择，必须是 A/B/C 之一
- 赢单概率：如果选择，必须是 High/Medium/Low 之一

## 三、商机状态流转规则

### 3.1 状态流转图

```
进行中 → 赢单 → （转为项目）
  ↓
沉默
  ↓
放弃
  ↓
输单
```

**状态说明**：
- `进行中`：商机正在跟进中，有进展
- `沉默`：商机暂时无进展，处于沉默状态（可以恢复为"进行中"）
- `赢单`：商机成功，获得项目，可以转为商业项目
- `输单`：商机失败，未获得项目
- `放弃`：主动放弃该商机

**状态变更规则**：
- 商机创建后，状态默认为"进行中"
- 可以从"进行中"转为"沉默"、"赢单"、"输单"、"放弃"
- 可以从"沉默"恢复为"进行中"
- "赢单"、"输单"、"放弃"为终态，不能再次变更
- 状态变更时，系统自动创建跟进记录

### 3.2 状态变更业务规则

**转为沉默**：
- 适用场景：商机暂时无进展，需要暂停跟进
- 操作：将状态改为"沉默"
- 规则：沉默的商机可以恢复为"进行中"

**转为赢单**：
- 适用场景：商机成功，获得项目
- 操作：将状态改为"赢单"
- 规则：
  - 赢单后可以转为商业项目（创建项目时关联该商机）
  - 赢单为终态，不能再次变更
  - 转为项目后，商机状态保持为"赢单"，用于历史记录

**转为输单**：
- 适用场景：商机失败，未获得项目
- 操作：将状态改为"输单"
- 规则：输单为终态，不能再次变更

**转为放弃**：
- 适用场景：主动放弃该商机
- 操作：将状态改为"放弃"
- 规则：放弃为终态，不能再次变更

## 四、跟进记录管理

### 4.1 跟进记录创建

**业务流程**：
1. 在商机详情页或列表页，点击"跟进"按钮
2. 填写跟进信息：
   - 跟进日期（必填，默认为今天）
   - 商机状态（必填，当前状态或新状态）
   - 赢单概率（可选）
   - 预估金额（可选）
   - 支持类型（可选）
   - 跟进备注（必填）
3. 提交后创建跟进记录

**业务规则**：
- 跟进日期必填，不能是未来日期
- 跟进备注必填，不能为空
- 如果更新了商机状态、赢单概率、预估金额、支持类型，系统同步更新商机信息
- 跟进记录创建后不可修改、不可删除（只读）

### 4.2 跟进记录展示

**展示位置**：
- 商机详情页：显示所有跟进记录，按时间倒序排列
- 跟进记录列表：显示跟进日期、状态、备注、操作人、操作时间

**展示内容**：
- 跟进日期
- 商机状态（跟进时的状态）
- 赢单概率（跟进时的概率）
- 预估金额（跟进时的金额）
- 支持类型（跟进时的类型）
- 跟进备注
- 操作人
- 操作时间

## 五、成本管理

### 5.1 成本来源

**成本类型**：
- **人力成本**：来源于关联的任务和工时记录
  - 从任务管理模块获取该商机关联的所有任务
  - 汇总所有任务的实际工时
  - 根据员工等级和城市类型计算人力成本
- **差旅成本**：来源于手动录入的差旅支出记录
  - 由专人手动录入差旅支出，关联到商机
  - 汇总该商机的所有差旅支出记录的总金额
- **外包成本**：来源于手动录入的外包支出记录
  - 由专人手动录入外包支出，关联到商机
  - 汇总该商机的所有外包支出记录的总金额

**成本计算规则**：
- 人力成本 = sum(任务实际工时 × 员工等级单价)
- 差旅成本 = sum(差旅支出记录.totalAmount)
- 外包成本 = sum(外包支出记录.amount)
- 总支出 = 人力成本 + 差旅成本 + 外包成本

### 5.2 差旅支出录入

**业务流程**：
1. 在商机详情页，点击"录入差旅支出"
2. 填写差旅信息：
   - 统计月份（必填，格式：YYYY-MM）
   - 出差事项（必填）
   - 费用明细：大交通、住宿、小交通、补助、其他（至少填写一项）
3. 系统自动计算总金额（各项费用之和）
4. 提交后保存差旅支出记录

**业务规则**：
- 统计月份必填，格式：YYYY-MM
- 出差事项必填，不能为空
- 至少填写一项费用（大交通、住宿、小交通、补助、其他）
- 总金额自动计算：各项费用之和
- 支持编辑和删除差旅支出记录

### 5.3 外包支出录入

**业务流程**：
1. 在商机详情页，点击"录入外包支出"
2. 填写外包信息：
   - 统计月份（必填，格式：YYYY-MM）
   - 外包事项（必填）
   - 供应商（必填）
   - 金额（必填，必须 > 0，单位：元）
3. 提交后保存外包支出记录

**业务规则**：
- 统计月份必填，格式：YYYY-MM
- 外包事项必填，不能为空
- 供应商必填，不能为空
- 金额必填，必须 > 0
- 支持编辑和删除外包支出记录

### 5.4 成本统计

**统计维度**：
- 按商机统计：每个商机的总支出、人力成本、差旅成本、外包成本
- 按月份统计：每个月的总支出、人力成本、差旅成本、外包成本
- 按部门统计：每个部门的总支出、人力成本、差旅成本、外包成本

**展示位置**：
- 商机列表页：显示成本列（总支出、人力成本、差旅成本、外包成本）
- 商机详情页：显示成本统计和明细
  - 人力成本明细：显示关联的任务和工时记录
  - 差旅成本明细：显示所有差旅支出记录列表
  - 外包成本明细：显示所有外包支出记录列表

## 六、任务和工时管理

### 6.1 任务创建

**业务流程**：
1. 在商机详情页，点击"创建任务"
2. 填写任务信息：任务名称、任务描述、选择执行者
3. 系统验证权限：检查当前用户是否为归属部门主管
4. 创建任务并保存到数据库

**业务规则**：
- 只有归属部门主管可以创建任务
- 任务创建后，可以分配计划工时
- 任务执行者可以录入实际工时

### 6.2 工时统计

**统计规则**：
- 商机的总计划工时：汇总该商机关联的所有任务的计划工时
- 商机的总实际工时：汇总该商机关联的所有任务的实际工时
- 商机的工时完成率：总实际工时 / 总计划工时 × 100%

**展示位置**：
- 商机详情页：显示工时统计
- 工时日历视图：支持筛选商机，查看该商机的工时分布

## 七、筛选和查询

### 7.1 筛选条件

**支持的筛选字段**：
- **所属体验组**：按归属部门筛选（下拉选择）
- **商机名称**：按名称模糊搜索（文本输入）
- **客户部**：按客户部筛选（下拉选择）
- **商务经理**：按商务经理筛选（文本输入）
- **类型**：按支持类型筛选（下拉选择，多选）

**筛选逻辑**：
- 所有筛选条件都是"且"的关系（AND）
- 支持多个筛选条件组合
- 筛选条件改变时，列表自动更新

### 7.2 状态筛选

**状态标签页**：
- **进行中**：显示状态为"进行中"的商机
- **沉默**：显示状态为"沉默"的商机
- **已结束**：显示状态为"赢单"、"输单"、"放弃"的商机

**筛选规则**：
- 点击状态标签页，切换显示对应状态的商机
- 状态筛选与其他筛选条件组合使用

### 7.3 列表展示

**列表字段**：
- 商机名称
- 等级（A/B/C，可为空）
- 状态（进行中/赢单/输单/沉默/放弃）
- 预估金额（单位：万元，可为空）
- 概率（高/中/低，可为空）
- 负责人
- 体验组（归属部门）
- 类型（支持类型，多个用"/"分隔）
- 创建日期（格式：YYYY-MM）
- 客户部（可为空）
- 商务经理（可为空）
- 备注（可为空）
- 成本（总支出、人力成本、差旅成本、外包成本）
- 操作（跟进按钮）

**排序规则**：
- 默认按创建时间倒序排列（最新的在前）
- 支持按创建日期、预估金额等字段排序

## 八、交互设计

### 8.1 商机列表页

**页面布局**：
- **顶部**：状态标签页（进行中、沉默、已结束）
- **筛选区域**：筛选条件输入框和按钮
- **列表区域**：商机列表表格
- **操作区域**：创建商机按钮

**筛选区域**：
- 所属体验组：下拉选择器
- 商机名称：文本输入框
- 客户部：下拉选择器
- 商务经理：文本输入框
- 类型：下拉选择器（多选）
- 搜索按钮：执行筛选
- 重置按钮：清空所有筛选条件

**列表操作**：
- 点击商机名称：跳转到商机详情页
- 点击"跟进"按钮：打开跟进弹窗
- 支持批量操作（如批量导出）

### 8.2 商机详情页

**页面布局**：
- **基本信息区域**：商机名称、状态、等级、概率、预估金额、负责人、归属部门、商务经理、客户部、创建日期、备注
- **任务列表区域**：显示该商机关联的所有任务
- **跟进记录区域**：显示所有跟进记录，按时间倒序
- **成本统计区域**：显示总支出、人力成本、差旅成本、外包成本
- **操作按钮**：创建任务、录入差旅支出、录入外包支出、跟进、编辑、删除

**任务列表**：
- 显示任务名称、执行者、状态、计划工时、实际工时
- 支持创建新任务
- 支持查看任务详情

**差旅支出列表**：
- 显示统计月份、出差事项、费用明细（大交通、住宿、小交通、补助、其他）、总金额
- 按统计月份倒序排列
- 支持录入新差旅支出
- 支持编辑和删除差旅支出记录

**外包支出列表**：
- 显示统计月份、外包事项、供应商、金额
- 按统计月份倒序排列
- 支持录入新外包支出
- 支持编辑和删除外包支出记录

**跟进记录列表**：
- 显示跟进日期、状态、概率、预估金额、支持类型、备注、操作人、操作时间
- 按时间倒序排列
- 支持创建新跟进记录

### 8.3 创建商机弹窗

**表单字段**：
- 商机名称（必填，文本输入）
- 负责人（必填，下拉选择）
- 归属部门（必填，下拉选择）
- 支持类型（必填，多选）
- 创建日期（必填，日期选择器，格式：YYYY-MM）
- 商机等级（可选，下拉选择：A/B/C）
- 赢单概率（可选，下拉选择：高/中/低）
- 预估金额（可选，数字输入，单位：万元）
- 商务经理（可选，文本输入）
- 客户部（可选，下拉选择）
- 备注（可选，文本域）

**交互流程**：
1. 填写必填字段
2. 可选填写其他字段
3. 点击"确定"创建商机
4. 创建成功后，跳转到商机详情页或刷新列表

### 8.4 跟进弹窗

**表单字段**：
- 跟进日期（必填，日期选择器，默认为今天）
- 商机状态（必填，下拉选择）
- 赢单概率（可选，下拉选择：高/中/低）
- 预估金额（可选，数字输入，单位：万元）
- 支持类型（可选，多选）
- 跟进备注（必填，文本域）

**交互流程**：
1. 系统自动填充当前商机的状态、概率、金额、支持类型
2. 用户可以修改这些信息
3. 填写跟进备注（必填）
4. 点击"确定"创建跟进记录
5. 如果更新了商机信息，系统同步更新商机

### 8.5 编辑商机

**可编辑字段**：
- 商机名称
- 负责人
- 归属部门
- 支持类型
- 商机等级
- 赢单概率
- 预估金额
- 商务经理
- 客户部
- 备注

**不可编辑字段**：
- 商机编号（自动生成，不可修改）
- 创建日期（创建后不可修改）
- 状态（通过跟进记录变更，不能直接编辑）

**编辑规则**：
- 只有归属部门主管可以编辑商机
- 编辑后保存，更新商机信息

### 8.6 录入差旅支出弹窗

**表单字段**：
- 统计月份（必填，日期选择器，格式：YYYY-MM）
- 出差事项（必填，文本输入）
- 大交通费用（可选，数字输入，单位：元）
- 住宿费用（可选，数字输入，单位：元）
- 小交通费用（可选，数字输入，单位：元）
- 补助费用（可选，数字输入，单位：元）
- 其他费用（可选，数字输入，单位：元）
- 总金额（自动计算，只读）

**交互流程**：
1. 填写统计月份和出差事项（必填）
2. 至少填写一项费用（大交通、住宿、小交通、补助、其他）
3. 系统自动计算总金额（各项费用之和）
4. 点击"确定"保存差旅支出记录
5. 保存成功后，刷新成本统计和差旅支出列表

### 8.7 录入外包支出弹窗

**表单字段**：
- 统计月份（必填，日期选择器，格式：YYYY-MM）
- 外包事项（必填，文本输入）
- 供应商（必填，文本输入）
- 金额（必填，数字输入，必须 > 0，单位：元）

**交互流程**：
1. 填写统计月份、外包事项、供应商、金额（必填）
2. 金额必须 > 0
3. 点击"确定"保存外包支出记录
4. 保存成功后，刷新成本统计和外包支出列表

## 九、数据统计和报表

### 9.1 商机统计

**统计维度**：
- 按状态统计：进行中、沉默、赢单、输单、放弃的数量
- 按部门统计：每个部门的商机数量
- 按月份统计：每个月的商机创建数量
- 按支持类型统计：每种支持类型的商机数量

### 9.2 成本分析

**分析维度**：
- 按商机分析：每个商机的成本投入（人力、差旅、外包）
- 按部门分析：每个部门的成本投入（人力、差旅、外包）
- 按月份分析：每个月的成本投入（人力、差旅、外包）
- 成本对比：预估金额 vs 实际成本
- 成本结构分析：人力成本、差旅成本、外包成本占比

### 9.3 转化率分析

**分析指标**：
- 赢单率：赢单数量 / 总商机数量 × 100%
- 输单率：输单数量 / 总商机数量 × 100%
- 平均跟进周期：从创建到结束的平均时间
- 平均成本：每个商机的平均成本投入

## 十、权限控制规则

### 10.1 商机管理权限

**创建权限**：
- 归属部门主管可以创建商机

**编辑权限**：
- 归属部门主管可以编辑商机

**删除权限**：
- 归属部门主管可以删除商机（建议软删除，保留历史记录）

**查看权限**：
- 所有用户都可以查看商机列表和详情
- 可以根据部门权限限制查看范围

### 10.2 成本录入权限

**差旅支出录入权限**：
- 归属部门主管可以录入差旅支出
- 负责人可以录入差旅支出
- 可以编辑和删除自己录入的差旅支出记录

**外包支出录入权限**：
- 归属部门主管可以录入外包支出
- 负责人可以录入外包支出
- 可以编辑和删除自己录入的外包支出记录

**查看成本权限**：
- 所有有查看商机权限的用户都可以查看成本统计和明细

### 10.3 跟进权限

**创建跟进记录权限**：
- 归属部门主管可以创建跟进记录
- 负责人可以创建跟进记录

**查看跟进记录权限**：
- 所有有查看商机权限的用户都可以查看跟进记录

### 10.4 任务管理权限

**创建任务权限**：
- 归属部门主管可以创建任务

**分配计划工时权限**：
- 归属部门主管可以分配计划工时

**录入实际工时权限**：
- 任务执行者本人可以录入实际工时

**说明**：具体的权限验证函数实现将在系统的权限管理文档中详细说明。

## 十一、总结

售前支持模块的核心逻辑是：
1. **商机管理**：支持创建、编辑、删除商机，记录商机的基本信息和状态
2. **状态流转**：支持商机状态的流转（进行中、沉默、赢单、输单、放弃）
3. **跟进记录**：记录商机的跟进历史，追踪状态变化
4. **任务和工时**：支持为商机创建任务，分配计划工时，录入实际工时（用于人力成本计算）
5. **成本管理**：统计商机的成本投入
   - 人力成本：来源于关联的任务和工时记录，自动计算
   - 差旅成本：由专人手动录入差旅支出记录，关联到商机
   - 外包成本：由专人手动录入外包支出记录，关联到商机
6. **筛选和查询**：支持多维度筛选和查询商机

主要特点：
1. 售前支持不涉及业绩录入和预算，只关注商机跟进和成本投入
2. 支持多种支持类型（评估报价、投标配合、POC方案、交流分享）
3. 支持商机等级和赢单概率设置，便于优先级管理
4. 通过跟进记录追踪商机状态变化历史
5. 赢单后可以转为商业项目
6. 成本管理分为三类：
   - 人力成本：通过任务和工时记录自动计算（任务是对内的管理）
   - 差旅成本：由专人手动录入，关联到商机（与任务无关）
   - 外包成本：由专人手动录入，关联到商机（与任务无关）
7. 支持多维度筛选和统计，便于管理和分析

