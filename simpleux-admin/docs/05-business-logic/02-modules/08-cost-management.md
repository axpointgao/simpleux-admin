# 成本管理模块业务逻辑规则

## 一、数据模型

### 1.1 核心实体

#### EmployeeMonthlyCost（员工月度完全人力成本）

**说明**：记录每个员工每月的完全人力成本，用于计算部门成本和驻场制项目成本。这里的"完全人力成本"是指员工的所有成本（包括工资、奖金、社保等），与任务工时计算的人力成本概念不同。

**核心字段**：
- `id`：成本记录ID（唯一标识）
- `employeeId`：员工ID（必填，关联到 `profiles.id`）
- `employeeName`：员工姓名（**历史快照字段**，创建时从员工表获取，后续不更新）
- `month`：月份（必填，格式：YYYY-MM）
- `workDays`：在职天数（必填，数字，0、0.5、1）
  - `0`：当月未在职
  - `0.5`：当月在职半个月
  - `1`：当月在职整月
- `employeeLevel`：员工级别（**历史快照字段**，创建时从员工表获取，后续不更新）
- `cityType`：城市类型（**历史快照字段**，创建时从员工表获取，后续不更新）
- `department`：员工部门（**历史快照字段**，创建时从员工表获取，后续不更新）
- `dailyCost`：人日成本（必填，数字，单位：元/天，从成本标准获取）
- `totalCost`：总成本（必填，数字，单位：元，计算公式：`dailyCost × workDays × 21.75`）
- `recordedBy`：录入人ID（必填，关联到 `profiles.id`）
- `recordedByName`：录入人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 每个员工每个月只能有一条成本记录
- `workDays` 只能是 0、0.5、1 三个值
- **历史数据快照机制**：
  - 创建成本记录时，系统自动快照员工的关键信息（姓名、级别、城市类型、部门）
  - 快照信息存储在成本记录中，后续员工信息变化不影响历史成本记录
  - 查询历史成本时，使用快照信息，而不是实时查询员工表
  - 即使员工离职、级别变化、部门调整，历史成本记录保持不变
- `dailyCost` 根据快照的 `employeeLevel`、`cityType` 和 `month` 从 `cost_standards` 表获取对应的成本标准
- `totalCost` 自动计算：`dailyCost × workDays × 21.75`（21.75为每月标准工作日）
- 只有财务人员可以录入和修改
- 支持批量导入（Excel格式）
- **历史数据保护**：成本记录创建后，快照字段（姓名、级别、城市类型、部门）不允许修改，确保历史数据的准确性

#### ProjectTravelCost（项目差旅成本）

**说明**：记录项目相关的差旅成本，由财务人员录入。与项目详情页的差旅支出功能并存，但成本管理模块提供统一的差旅成本管理入口。

**核心字段**：
- `id`：成本记录ID（唯一标识）
- `projectId`：项目ID（必填，关联到 `projects.id`）
- `projectName`：项目名称（冗余字段，便于查询）
- `month`：月份（必填，格式：YYYY-MM）
- `item`：出差事项（必填，文本）
- `transportBig`：大交通费用（可选，数字，单位：元）
- `stay`：住宿费用（可选，数字，单位：元）
- `transportSmall`：小交通费用（可选，数字，单位：元）
- `allowance`：差旅补贴（可选，数字，单位：元）
- `other`：其他费用（可选，数字，单位：元）
- `totalCost`：总成本（必填，数字，单位：元，计算公式：`transportBig + stay + transportSmall + allowance + other`）
- `recordedBy`：录入人ID（必填，关联到 `profiles.id`）
- `recordedByName`：录入人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 一个项目一个月可以有多条差旅成本记录
- `totalCost` 自动计算：所有费用项之和
- 只有财务人员可以录入和修改
- 与项目详情页的差旅支出功能并存，数据共享（同一张表或关联表）

#### ProjectOutsourceCost（项目外包成本）

**说明**：记录项目相关的外包成本，由财务人员录入。与项目详情页的外包支出功能并存，但成本管理模块提供统一的外包成本管理入口。

**核心字段**：
- `id`：成本记录ID（唯一标识）
- `projectId`：项目ID（必填，关联到 `projects.id`）
- `projectName`：项目名称（冗余字段，便于查询）
- `month`：月份（必填，格式：YYYY-MM）
- `item`：外包事项（必填，文本）
- `supplierId`：供应商ID（可选，关联到 `suppliers.id`）
- `supplierName`：供应商名称（冗余字段，便于查询）
- `amount`：外包金额（必填，数字，单位：元）
- `recordedBy`：录入人ID（必填，关联到 `profiles.id`）
- `recordedByName`：录入人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 一个项目一个月可以有多条外包成本记录
- 只有财务人员可以录入和修改
- 与项目详情页的外包支出功能并存，数据共享（同一张表或关联表）

#### OpportunityTravelCost（商机差旅成本）

**说明**：记录售前支持商机相关的差旅成本，由财务人员录入。

**核心字段**：
- `id`：成本记录ID（唯一标识）
- `opportunityId`：商机ID（必填，关联到 `opportunities.id`）
- `opportunityName`：商机名称（冗余字段，便于查询）
- `month`：月份（必填，格式：YYYY-MM）
- `item`：出差事项（必填，文本）
- `transportBig`：大交通费用（可选，数字，单位：元）
- `stay`：住宿费用（可选，数字，单位：元）
- `transportSmall`：小交通费用（可选，数字，单位：元）
- `allowance`：差旅补贴（可选，数字，单位：元）
- `other`：其他费用（可选，数字，单位：元）
- `totalCost`：总成本（必填，数字，单位：元，计算公式：`transportBig + stay + transportSmall + allowance + other`）
- `recordedBy`：录入人ID（必填，关联到 `profiles.id`）
- `recordedByName`：录入人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 一个商机一个月可以有多条差旅成本记录
- `totalCost` 自动计算：所有费用项之和
- 只有财务人员可以录入和修改

#### OpportunityOutsourceCost（商机外包成本）

**说明**：记录售前支持商机相关的外包成本，由财务人员录入。

**核心字段**：
- `id`：成本记录ID（唯一标识）
- `opportunityId`：商机ID（必填，关联到 `opportunities.id`）
- `opportunityName`：商机名称（冗余字段，便于查询）
- `month`：月份（必填，格式：YYYY-MM）
- `item`：外包事项（必填，文本）
- `supplierId`：供应商ID（可选，关联到 `suppliers.id`）
- `supplierName`：供应商名称（冗余字段，便于查询）
- `amount`：外包金额（必填，数字，单位：元）
- `recordedBy`：录入人ID（必填，关联到 `profiles.id`）
- `recordedByName`：录入人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 一个商机一个月可以有多条外包成本记录
- 只有财务人员可以录入和修改

#### DepartmentCost（部门成本统计）

**说明**：部门成本的汇总统计，不存储为实体，而是通过计算得出。

**计算公式**：
```
部门成本 = 部门人力成本 + 部门项目差旅成本 + 部门项目外包成本 + 部门商机差旅成本 + 部门商机外包成本
```

**计算规则**：
- **部门人力成本**：该部门所有员工在指定月份的人力成本总和
  - `部门人力成本 = sum(员工月度完全人力成本.totalCost WHERE 员工月度完全人力成本.部门 = 指定部门 AND 月份 = 指定月份)`
  - **重要**：使用成本记录中的历史快照部门信息，而不是实时查询员工表的当前部门
  - 即使员工后续部门调整，历史成本仍归属于当时的部门
- **部门项目差旅成本**：该部门归属项目的差旅成本总和
  - `部门项目差旅成本 = sum(项目差旅成本.totalCost WHERE 项目.归属部门 = 指定部门 AND 月份 = 指定月份)`
  - **注意**：项目归属部门在项目创建时确定，后续调整不影响历史成本归属
- **部门项目外包成本**：该部门归属项目的外包成本总和
  - `部门项目外包成本 = sum(项目外包成本.amount WHERE 项目.归属部门 = 指定部门 AND 月份 = 指定月份)`
- **部门商机差旅成本**：该部门归属商机的差旅成本总和
  - `部门商机差旅成本 = sum(商机差旅成本.totalCost WHERE 商机.归属部门 = 指定部门 AND 月份 = 指定月份)`
- **部门商机外包成本**：该部门归属商机的外包成本总和
  - `部门商机外包成本 = sum(商机外包成本.amount WHERE 商机.归属部门 = 指定部门 AND 月份 = 指定月份)`

## 二、完全人力成本管理

### 2.1 成本标准配置

**说明**：成本标准在系统设置模块中配置（见系统设置模块文档），成本管理模块使用成本标准来计算员工月度成本。

**成本标准来源**：
- 从 `cost_standards` 表获取
- 根据员工级别（`employeeLevel`）、城市类型（`cityType`）和月份查找对应的成本标准
- 如果找不到对应的成本标准，提示错误，不允许录入

### 2.2 员工月度成本录入

**功能说明**：
- 财务人员按月录入每个员工的完全人力成本
- 录入维度只需要一个数值（`totalCost`），不需要复杂的各类工资、奖金等
- 系统根据成本标准自动计算 `dailyCost`，然后根据 `workDays` 计算 `totalCost`

**业务流程**：
1. 财务人员在成本管理页面进入"人力成本管理"
2. 选择月份，查看该月份的成本记录列表
3. 创建新的成本记录：
   - 选择员工（从员工列表选择）
   - 系统自动带出员工级别和城市类型
   - 系统根据员工级别、城市类型和月份从成本标准获取 `dailyCost`
   - 输入在职天数（`workDays`：0、0.5、1）
   - 系统自动计算 `totalCost = dailyCost × workDays × 21.75`
4. 编辑或删除现有成本记录

**业务规则**：
- 每个员工每个月只能有一条成本记录
- `workDays` 只能是 0、0.5、1 三个值
- `dailyCost` 必须从成本标准获取，如果找不到对应的成本标准，不允许录入
- `totalCost` 自动计算，不允许手动修改
- 只有财务人员可以录入和修改
- 支持批量导入（Excel格式）：
  - Excel格式：员工姓名、月份、在职天数
  - 系统自动匹配员工、获取成本标准、计算总成本

### 2.3 成本标准查询

**查询规则**：
- 根据员工级别、城市类型和月份查询对应的成本标准
- 如果查询月份在成本标准的生效时间范围内，且成本标准已启用，则返回该成本标准
- 如果有多条成本标准符合条件，返回生效开始日期最新的那条

## 三、差旅成本管理

### 3.1 项目差旅成本录入

**功能说明**：
- 财务人员按月录入项目相关的差旅成本
- 与项目详情页的差旅支出功能并存，数据共享

**业务流程**：
1. 财务人员在成本管理页面进入"差旅成本管理"
2. 选择月份，查看该月份的成本记录列表（可按项目筛选）
3. 创建新的成本记录：
   - 选择项目（从项目列表选择）
   - 输入出差事项
   - 输入各项费用（大交通、住宿、小交通、差旅补贴、其他）
   - 系统自动计算总成本
4. 编辑或删除现有成本记录

**业务规则**：
- 一个项目一个月可以有多条差旅成本记录
- `totalCost` 自动计算：所有费用项之和
- 只有财务人员可以录入和修改
- 与项目详情页的差旅支出功能并存，数据共享（同一张表或关联表）

### 3.2 商机差旅成本录入

**功能说明**：
- 财务人员按月录入商机相关的差旅成本

**业务流程**：
1. 财务人员在成本管理页面进入"差旅成本管理"
2. 切换到"商机差旅"标签
3. 选择月份，查看该月份的成本记录列表（可按商机筛选）
4. 创建新的成本记录：
   - 选择商机（从商机列表选择）
   - 输入出差事项
   - 输入各项费用（大交通、住宿、小交通、差旅补贴、其他）
   - 系统自动计算总成本
5. 编辑或删除现有成本记录

**业务规则**：
- 一个商机一个月可以有多条差旅成本记录
- `totalCost` 自动计算：所有费用项之和
- 只有财务人员可以录入和修改

## 四、外包成本管理

### 4.1 项目外包成本录入

**功能说明**：
- 财务人员按月录入项目相关的外包成本
- 与项目详情页的外包支出功能并存，数据共享

**业务流程**：
1. 财务人员在成本管理页面进入"外包成本管理"
2. 选择月份，查看该月份的成本记录列表（可按项目筛选）
3. 创建新的成本记录：
   - 选择项目（从项目列表选择）
   - 输入外包事项
   - 选择供应商（可选，从供应商列表选择）
   - 输入外包金额
4. 编辑或删除现有成本记录

**业务规则**：
- 一个项目一个月可以有多条外包成本记录
- 只有财务人员可以录入和修改
- 与项目详情页的外包支出功能并存，数据共享（同一张表或关联表）

### 4.2 商机外包成本录入

**功能说明**：
- 财务人员按月录入商机相关的外包成本

**业务流程**：
1. 财务人员在成本管理页面进入"外包成本管理"
2. 切换到"商机外包"标签
3. 选择月份，查看该月份的成本记录列表（可按商机筛选）
4. 创建新的成本记录：
   - 选择商机（从商机列表选择）
   - 输入外包事项
   - 选择供应商（可选，从供应商列表选择）
   - 输入外包金额
5. 编辑或删除现有成本记录

**业务规则**：
- 一个商机一个月可以有多条外包成本记录
- 只有财务人员可以录入和修改

## 五、部门成本计算

### 5.1 部门成本统计

**功能说明**：
- 按部门和月份统计部门总成本
- 部门成本包括：人力成本、项目差旅成本、项目外包成本、商机差旅成本、商机外包成本

**计算公式**：
```
部门成本 = 部门人力成本 + 部门项目差旅成本 + 部门项目外包成本 + 部门商机差旅成本 + 部门商机外包成本
```

**计算规则**：
- **部门人力成本**：该部门所有员工在指定月份的人力成本总和
- **部门项目差旅成本**：该部门归属项目的差旅成本总和
- **部门项目外包成本**：该部门归属项目的外包成本总和
- **部门商机差旅成本**：该部门归属商机的差旅成本总和
- **部门商机外包成本**：该部门归属商机的外包成本总和

**业务流程**：
1. 财务人员或部门主管在成本管理页面进入"部门成本统计"
2. 选择部门和月份，查看该部门该月份的成本明细
3. 查看成本构成：
   - 人力成本明细（按员工列表）
   - 项目差旅成本明细（按项目列表）
   - 项目外包成本明细（按项目列表）
   - 商机差旅成本明细（按商机列表）
   - 商机外包成本明细（按商机列表）
4. 支持导出成本明细（Excel格式）

### 5.2 部门利润计算

**说明**：部门利润 = 部门业绩 - 部门成本

**计算公式**：
```
部门利润 = 部门业绩 - 部门成本
```

**计算规则**：
- **部门业绩**：该部门归属项目和商机的业绩总和（从业绩管理模块获取）
- **部门成本**：按上述规则计算

**业务流程**：
1. 财务人员或部门主管在成本管理页面进入"部门利润统计"
2. 选择部门和月份，查看该部门该月份的利润情况
3. 查看利润构成：
   - 部门业绩
   - 部门成本（明细）
   - 部门利润

## 六、驻场制项目成本计算

### 6.1 成本计算规则

**说明**：驻场制项目的成本计算与业绩登记关联，每个月登记业绩时会选择人员，系统自动计算成本。

**业务流程**：
1. 项目经理或财务人员在业绩管理模块登记驻场制项目的月度业绩
2. 登记业绩时，选择参与人员（可多选）
3. 系统自动计算该月的项目成本：
   - 根据选择的员工，查找该员工该月的完全人力成本（`EmployeeMonthlyCost`）
   - **重要**：使用历史快照的员工信息（姓名、级别、城市类型、部门），而不是实时查询员工表
   - 如果找不到对应的成本记录，提示错误，不允许提交业绩登记
   - 项目成本 = 所有选择员工的完全人力成本总和
4. 系统自动创建项目成本记录（或更新现有记录）

**业务规则**：
- 驻场制项目的成本必须基于已录入的员工月度完全人力成本
- 如果员工该月的完全人力成本未录入，不允许提交业绩登记
- 项目成本 = sum(选择员工的完全人力成本.totalCost)
- 成本记录与业绩记录关联（通过月份关联）
- **历史数据保护**：即使员工后续离职、级别变化、部门调整，历史成本记录保持不变，使用快照信息

### 6.2 成本记录管理

**说明**：驻场制项目的成本记录由系统自动创建，财务人员可以查看和核对。

**业务流程**：
1. 财务人员在成本管理页面查看驻场制项目的成本记录
2. 查看成本明细：
   - 按月份查看
   - 查看每个月的参与人员和成本（使用历史快照信息）
   - 查看项目总成本
3. 如果发现成本记录有误，可以：
   - 修改员工的月度完全人力成本（如果录入错误）
   - 重新登记业绩（如果人员选择错误）

**业务规则**：
- 成本记录由系统自动创建，财务人员不能手动创建或删除
- 如果修改员工的月度完全人力成本，系统自动重新计算关联的项目成本
- 如果重新登记业绩（修改人员选择），系统自动更新项目成本记录
- **历史数据展示**：查看成本明细时，显示员工的历史快照信息（姓名、级别、城市类型、部门），即使员工已离职、级别已变化、部门已调整

## 七、成本查询和统计

### 7.1 成本查询

**查询维度**：
- 按月份查询
- 按部门查询
- 按项目查询
- 按商机查询
- 按员工查询
- 按成本类型查询（人力、差旅、外包）

**查询功能**：
- 支持多维度组合查询
- 支持导出查询结果（Excel格式）
- 支持成本明细查看

### 7.2 成本统计

**统计维度**：
- 部门成本统计（按月份）
- 项目成本统计（按月份）
- 商机成本统计（按月份）
- 员工成本统计（按月份）
- 成本类型统计（人力、差旅、外包）

**统计功能**：
- 支持图表展示（柱状图、折线图、饼图）
- 支持同比、环比分析
- 支持成本趋势分析

## 八、权限控制规则

### 8.1 成本录入权限

**财务人员**：
- 可以录入和修改所有类型的成本（人力、差旅、外包）
- 可以查看所有成本记录
- 可以导出成本数据

**部门主管**：
- 可以查看本部门的成本统计
- 不能录入和修改成本

**项目经理**：
- 可以查看关联项目的成本明细
- 不能录入和修改成本（驻场制项目除外，可以通过业绩登记间接影响成本）

**普通员工**：
- 不能访问成本管理模块

### 8.2 成本查看权限

**财务人员**：
- 可以查看所有成本记录和统计

**部门主管**：
- 可以查看本部门的成本统计和明细

**项目经理**：
- 可以查看关联项目的成本明细

**普通员工**：
- 不能查看成本信息

## 九、数据完整性规则

### 9.1 数据验证

**员工月度成本**：
- 员工ID必须存在
- 月份格式必须正确（YYYY-MM）
- 在职天数必须是 0、0.5、1 之一
- 成本标准必须存在（根据员工级别、城市类型和月份查找）

**差旅成本**：
- 项目ID或商机ID必须存在
- 月份格式必须正确（YYYY-MM）
- 出差事项不能为空
- 至少有一项费用 > 0

**外包成本**：
- 项目ID或商机ID必须存在
- 月份格式必须正确（YYYY-MM）
- 外包事项不能为空
- 外包金额必须 > 0

### 9.2 数据关联

**员工月度成本与成本标准**：
- 员工月度成本的 `dailyCost` 必须从成本标准获取
- 如果成本标准不存在，不允许创建成本记录

**驻场制项目成本与员工月度成本**：
- 驻场制项目的成本必须基于已录入的员工月度完全人力成本
- 如果员工该月的完全人力成本未录入，不允许提交业绩登记

**部门成本计算**：
- 部门成本基于该部门的所有成本记录计算
- 如果成本记录缺失，部门成本统计可能不准确

## 十、历史数据保护规则

### 10.1 人员变化对历史数据的影响

**说明**：在实际业务场景中，会涉及到人员的离职、人员等级的变化、人员组织架构的调整等变化。这些变化不应该影响历史成本数据。

**保护机制**：

1. **历史数据快照**：
   - 创建成本记录时，系统自动快照员工的关键信息（姓名、级别、城市类型、部门）
   - 快照信息存储在成本记录中，作为历史数据的一部分
   - 后续员工信息变化不影响已创建的成本记录

2. **历史数据查询**：
   - 查询历史成本时，使用快照信息，而不是实时查询员工表
   - 即使员工已离职、级别已变化、部门已调整，历史成本记录仍显示当时的信息
   - 确保历史数据的准确性和可追溯性

3. **部门成本统计**：
   - 部门成本统计基于历史快照的部门信息
   - 即使员工后续部门调整，历史成本仍归属于当时的部门
   - 确保历史部门成本统计的准确性

### 10.2 具体场景处理

**场景1：员工离职**：
- 历史成本记录保留，显示员工当时的姓名、级别、部门等信息
- 查询历史成本时，可以正常显示已离职员工的信息
- 部门成本统计中，已离职员工的历史成本仍归属于当时的部门

**场景2：员工级别变化**：
- 历史成本记录中的员工级别保持不变，显示当时的级别
- 新创建的成本记录使用新的级别
- 历史成本记录和新的成本记录可以同时存在，互不影响

**场景3：员工部门调整**：
- 历史成本记录中的部门信息保持不变，显示当时的部门
- 部门成本统计时，历史成本仍归属于当时的部门
- 新创建的成本记录使用新的部门
- 确保历史部门成本统计的准确性

**场景4：员工城市类型变化**：
- 历史成本记录中的城市类型保持不变，显示当时的城市类型
- 新创建的成本记录使用新的城市类型
- 历史成本记录和新的成本记录可以同时存在，互不影响

### 10.3 数据完整性保证

**快照字段不可修改**：
- 成本记录创建后，快照字段（姓名、级别、城市类型、部门）不允许修改
- 如果发现快照信息有误，只能删除记录后重新创建，不能直接修改快照字段
- 确保历史数据的完整性和可追溯性

**查询和统计规则**：
- 所有历史成本查询和统计都基于快照信息
- 不依赖员工表的实时数据
- 确保历史数据的准确性和一致性

## 十一、总结

成本管理模块的核心逻辑是：
1. **完全人力成本管理**：财务人员按月录入每个员工的完全人力成本，基于成本标准自动计算
2. **差旅成本管理**：财务人员按月录入项目和商机的差旅成本
3. **外包成本管理**：财务人员按月录入项目和商机的外包成本
4. **部门成本计算**：部门成本 = 人力成本 + 归属项目和商机的差旅 + 外包成本
5. **驻场制项目成本计算**：与业绩登记关联，选择人员后自动计算成本

主要特点：
1. 统一的成本管理入口，集中管理所有成本数据
2. 财务人员负责录入，确保数据准确性
3. 基于成本标准自动计算，减少人工错误
4. 支持部门成本统计，便于成本分析和利润计算
5. 驻场制项目成本与业绩登记关联，自动化程度高

