# 系统设置模块业务逻辑规则

## 一、数据模型

### 1.1 核心实体

#### CostStandard（人日成本标准）

**核心字段**：
- `id`：成本标准ID（唯一标识）
- `employeeLevel`：员工级别（必填，枚举：P0-P9, M0-M5）
- `cityType`：城市类型（必填，枚举：'Chengdu' | 'Hangzhou'）
- `dailyCost`：人日成本（必填，数字，单位：元）
- `effectiveFrom`：生效开始日期（必填，格式：YYYY-MM-DD）
- `effectiveTo`：生效结束日期（可选，格式：YYYY-MM-DD，为空表示永久有效）
- `isActive`：是否启用（必填，boolean，默认：true）
- `createdBy`：创建人ID（必填）
- `createdByName`：创建人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 同一员工级别和城市类型的成本标准，在同一时间段内只能有一条有效记录
- 成本标准可以设置生效时间范围，支持历史成本标准查询
- 成本标准可以启用/禁用，禁用的成本标准不参与计算
- 系统在计算人力成本时，根据员工级别、城市类型和日期查找对应的成本标准

#### Role（角色）

**核心字段**：
- `id`：角色ID（唯一标识）
- `code`：角色代码（必填，唯一，如：'admin'、'manager'、'employee'）
- `name`：角色名称（必填，如：'系统管理员'、'部门主管'、'员工'）
- `description`：角色描述（可选）
- `isSystem`：是否系统角色（必填，boolean，系统角色不能删除）
- `permissions`：权限列表（数组，关联权限ID）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 角色代码必须唯一
- 系统角色不能删除，只能禁用
- 角色可以关联多个权限
- 用户通过角色获得权限

#### Permission（权限）

**核心字段**：
- `id`：权限ID（唯一标识）
- `code`：权限代码（必填，唯一，如：'project.create'、'project.edit'）
- `name`：权限名称（必填，如：'创建项目'、'编辑项目'）
- `module`：所属模块（必填，如：'project'、'performance'、'contribution'）
- `action`：操作类型（必填，如：'create'、'edit'、'delete'、'view'）
- `description`：权限描述（可选）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 权限代码必须唯一
- 权限按模块和操作类型组织
- 权限可以分配给角色或用户

#### ApprovalProcessTemplate（审批流程模板）

**审批类型（`type`）**：
- `project_create`：项目创建
- `project_change`：项目变更
- `project_post_record`：项目补录
- `expense_travel`：差旅费用
- `expense_outsource`：外包费用
- `design_confirm`：设计确认
- `contribution_create`：专业贡献立项
- `contribution_acceptance`：专业贡献验收
- `performance_acceptance`：业绩验收

**核心字段**：
- `id`：审批流程模板ID（唯一标识）
- `type`：审批类型（必填，唯一）
- `name`：模板名称（必填，如：'项目创建审批流程'）
- `description`：模板描述（可选）
- `steps`：审批步骤配置（JSON格式，必填）
- `isActive`：是否启用（必填，boolean，默认：true）
- `createdBy`：创建人ID（必填）
- `createdByName`：创建人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**审批步骤配置（`steps`）**：
- `stepIndex`：步骤索引（从0开始）
- `stepName`：步骤名称（如：'部门主管审批'）
- `approverType`：审批人类型（'user' | 'role'）
- `approverId`：审批人ID（具体用户ID或角色ID）
- `approverName`：审批人名称
- `isRequired`：是否必审（boolean，默认：true）

**业务规则**：
- 每个审批类型只能有一个启用的审批流程模板
- 审批步骤按索引顺序执行
- 审批人可以是具体用户或角色
- 如果审批人类型是角色，需要根据业务实体的归属部门确定具体的审批人

#### Holiday（节假日）

**核心字段**：
- `id`：节假日ID（唯一标识）
- `date`：日期（必填，格式：YYYY-MM-DD）
- `name`：节假日名称（必填，如：'元旦'、'春节'、'国庆节'）
- `type`：类型（必填，枚举：'holiday' | 'workday'，默认：'holiday'）
- `year`：年份（必填，用于快速查询）
- `createdBy`：创建人ID（必填）
- `createdByName`：创建人姓名
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 节假日用于排除计划工时和实际工时的分配日期
- 支持设置调休工作日（`type = 'workday'`），在周末或节假日标记为工作日
- 节假日数据由系统管理员维护
- 系统在计算工作日时，自动排除节假日，包含调休工作日

#### ClientDepartment（客户部）

**核心字段**：
- `id`：客户部ID（唯一标识）
- `code`：客户部代码（必填，唯一，如：'DEPT001'）
- `name`：客户部名称（必填，如：'客户部A'）
- `description`：客户部描述（可选）
- `isActive`：是否启用（必填，boolean，默认：true）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 客户部代码必须唯一
- 客户部可以启用/禁用，禁用的客户部不在下拉选择中显示
- 客户部用于项目、售前支持等业务实体的归属部门选择

#### Supplier（供应商）

**核心字段**：
- `id`：供应商ID（唯一标识）
- `name`：供应商名称（必填，唯一）
- `contact`：联系人（可选）
- `phone`：联系电话（可选）
- `email`：邮箱（可选）
- `address`：地址（可选）
- `isActive`：是否启用（必填，boolean，默认：true）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 供应商名称必须唯一
- 供应商可以启用/禁用，禁用的供应商不在下拉选择中显示
- 供应商用于项目、售前支持等业务实体的外包费用选择

#### NotificationConfig（通知配置）

**核心字段**：
- `id`：通知配置ID（唯一标识）
- `type`：通知类型（必填，如：'approval'、'project_status_change'）
- `channel`：通知渠道（必填，枚举：'dingtalk'）
- `enabled`：是否启用（必填，boolean，默认：true）
- `template`：通知模板（可选，JSON格式）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 通知配置用于控制各种通知的发送
- 支持启用/禁用通知
- 支持自定义通知模板

#### SystemParameter（系统参数）

**核心字段**：
- `id`：系统参数ID（唯一标识）
- `key`：参数键（必填，唯一，如：'default_project_status'）
- `value`：参数值（必填，文本或JSON格式）
- `description`：参数描述（可选）
- `category`：参数分类（可选，如：'business'、'system'）
- `createdAt`：创建时间
- `updatedAt`：更新时间

**业务规则**：
- 参数键必须唯一
- 参数值可以是文本或JSON格式
- 系统参数用于存储系统配置和业务规则参数

## 二、人日成本设置

### 2.1 成本标准管理

**功能说明**：
- 设置不同员工级别和城市类型的人日成本标准
- 支持设置生效时间范围，用于历史成本标准查询
- 支持启用/禁用成本标准

**业务流程**：
1. 系统管理员在系统设置页面进入"人日成本设置"
2. 查看现有成本标准列表
3. 创建新的成本标准：
   - 选择员工级别（P0-P9, M0-M5）
   - 选择城市类型（Chengdu / Hangzhou）
   - 输入人日成本（元）
   - 设置生效开始日期和结束日期（可选）
   - 设置是否启用
4. 编辑或删除现有成本标准

**业务规则**：
- 同一员工级别和城市类型的成本标准，在同一时间段内只能有一条有效记录
- 生效日期不能重叠
- 成本标准可以设置生效时间范围，支持历史成本标准查询
- 成本标准可以启用/禁用，禁用的成本标准不参与计算
- 系统在计算人力成本时，根据员工级别、城市类型和日期查找对应的成本标准

### 2.2 成本标准查询

**查询规则**：
- 根据员工级别、城市类型和日期查询对应的成本标准
- 如果查询日期在成本标准的生效时间范围内，且成本标准已启用，则返回该成本标准
- 如果有多条成本标准符合条件，返回生效开始日期最新的那条

## 三、角色权限设置

### 3.1 角色管理

**功能说明**：
- 创建和管理系统角色
- 为角色分配权限
- 支持启用/禁用角色

**业务流程**：
1. 系统管理员在系统设置页面进入"角色权限设置"
2. 查看现有角色列表
3. 创建新角色：
   - 输入角色代码（唯一）
   - 输入角色名称
   - 输入角色描述（可选）
   - 选择权限列表
4. 编辑或删除现有角色（系统角色不能删除）

**业务规则**：
- 角色代码必须唯一
- 系统角色不能删除，只能禁用
- 角色可以关联多个权限
- 用户通过角色获得权限

### 3.2 权限管理

**功能说明**：
- 管理系统权限
- 权限按模块和操作类型组织

**业务流程**：
1. 系统管理员在系统设置页面进入"权限管理"
2. 查看现有权限列表（按模块分组）
3. 创建新权限：
   - 输入权限代码（唯一）
   - 输入权限名称
   - 选择所属模块
   - 选择操作类型
   - 输入权限描述（可选）
4. 编辑或删除现有权限

**业务规则**：
- 权限代码必须唯一
- 权限按模块和操作类型组织
- 权限可以分配给角色或用户

## 四、审批流程设置

### 4.1 审批流程模板管理

**功能说明**：
- 创建和管理审批流程模板
- 为不同审批类型配置审批步骤
- 支持启用/禁用审批流程模板

**审批类型**：
- `project_create`：项目创建
- `project_change`：项目变更
- `project_post_record`：项目补录
- `expense_travel`：差旅费用
- `expense_outsource`：外包费用
- `design_confirm`：设计确认
- `contribution_create`：专业贡献立项
- `contribution_acceptance`：专业贡献验收
- `performance_acceptance`：业绩验收

**业务流程**：
1. 系统管理员在系统设置页面进入"审批流程设置"
2. 查看现有审批流程模板列表
3. 创建新审批流程模板：
   - 选择审批类型（唯一）
   - 输入模板名称
   - 输入模板描述（可选）
   - 配置审批步骤：
     - 设置步骤索引（从0开始）
     - 设置步骤名称
     - 选择审批人类型（用户/角色）
     - 设置审批人ID（具体用户ID或角色ID）
     - 设置是否必审
   - 设置是否启用
4. 编辑或删除现有审批流程模板

**业务规则**：
- 每个审批类型只能有一个启用的审批流程模板
- 审批步骤按索引顺序执行
- 审批人可以是具体用户或角色
- 如果审批人类型是角色，需要根据业务实体的归属部门确定具体的审批人

### 4.2 审批流程应用

**应用规则**：
- 创建审批时，根据审批类型查找对应的审批流程模板
- 如果找到启用的审批流程模板，使用该模板创建审批步骤
- 如果未找到启用的审批流程模板，提示错误
- 审批步骤根据模板配置自动创建
- 审批人根据审批流程模板配置自动确定
- 创建审批时，根据审批类型查找对应的审批流程模板，并在系统内创建审批记录。同时，系统调用钉钉API为当前步骤的审批人创建待办任务，并发送通知。钉钉待办任务的跳转链接指向系统内审批页面。审批人收到通知后，点击跳转到系统内审批页面进行审批。系统内审批通过或拒绝后，系统调用钉钉API更新对应的待办任务状态为"已完成"。

## 五、节假日管理

### 5.1 节假日数据来源

**方案1：使用第三方API（推荐）**：
- 使用节假日API（如：https://timor.tech/api/holiday）
- 自动获取每年的节假日数据
- 支持查询指定年份的节假日
- 系统自动同步到本地数据库

**方案2：本地手动配置**：
- 管理员在系统设置页面，手动配置每年的节假日
- 支持批量导入节假日数据（Excel格式）
- 支持单个添加、编辑、删除节假日

**业务规则**：
- 优先使用第三方API自动获取
- 如果API获取失败，可以手动配置
- 支持两种方式混合使用

### 5.2 节假日配置

**业务流程**：
1. 管理员在系统设置页面，进入"节假日管理"
2. 选择年份，查看该年份的节假日列表
3. 可以添加、编辑、删除节假日
4. 支持批量导入（Excel格式）

**节假日类型**：
- `holiday`：节假日（不工作）
- `workday`：调休工作日（工作，如：国庆调休）

**业务规则**：
- 日期必须唯一
- 支持跨年配置
- 用于工时计算，排除节假日，包含调休工作日

### 5.3 节假日应用

**应用场景**：
- 计划工时分配：自动排除节假日和周末，只分配到工作日
- 实际工时录入：自动排除节假日和周末，只分配到工作日
- 工作日计算：根据日期区间，排除节假日和周末，计算工作日数量

## 六、客户部管理

### 6.1 客户部管理

**功能说明**：
- 创建和管理客户部
- 客户部不在钉钉的组织架构中，需要手动维护
- 支持启用/禁用客户部

**业务流程**：
1. 管理员在系统设置页面，进入"客户部管理"
2. 查看现有客户部列表
3. 创建新客户部：
   - 输入客户部代码（唯一）
   - 输入客户部名称
   - 输入客户部描述（可选）
   - 设置是否启用
4. 编辑或删除现有客户部

**业务规则**：
- 客户部代码必须唯一
- 客户部可以启用/禁用，禁用的客户部不在下拉选择中显示
- 客户部用于项目、售前支持等业务实体的归属部门选择

## 七、供应商管理

### 7.1 供应商管理

**功能说明**：
- 创建和管理供应商
- 支持启用/禁用供应商

**业务流程**：
1. 管理员在系统设置页面，进入"供应商管理"
2. 查看现有供应商列表
3. 创建新供应商：
   - 输入供应商名称（唯一）
   - 输入联系人（可选）
   - 输入联系电话（可选）
   - 输入邮箱（可选）
   - 输入地址（可选）
   - 设置是否启用
4. 编辑或删除现有供应商

**业务规则**：
- 供应商名称必须唯一
- 供应商可以启用/禁用，禁用的供应商不在下拉选择中显示
- 供应商用于项目、售前支持等业务实体的外包费用选择

## 八、通知设置

### 8.1 通知配置

**功能说明**：
- 配置各种通知的发送渠道和模板
- 支持启用/禁用通知
- 支持自定义通知模板

**通知类型**：
- `approval`：审批通知
- `project_status_change`：项目状态变更通知
- `contribution_approval`：专业贡献审批通知
- `performance_acceptance`：业绩验收通知

**业务流程**：
1. 管理员在系统设置页面，进入"通知设置"
2. 查看现有通知配置列表
3. 创建或编辑通知配置：
   - 选择通知类型
   - 选择通知渠道（目前只支持钉钉）
   - 设置是否启用
   - 配置通知模板（可选）
4. 测试通知发送

**业务规则**：
- 通知通过钉钉接口发送
- 点击通知后跳转到具体的审批页面或详情页面
- 支持变量占位符，如：`{approvalId}`, `{projectId}`等

## 九、系统参数设置

### 9.1 系统参数管理

**功能说明**：
- 管理系统参数和业务规则参数
- 支持按分类组织参数

**参数分类**：
- `business`：业务规则参数
- `system`：系统配置参数

**业务流程**：
1. 管理员在系统设置页面，进入"系统参数设置"
2. 查看现有系统参数列表（按分类分组）
3. 创建新系统参数：
   - 输入参数键（唯一）
   - 输入参数值（文本或JSON格式）
   - 输入参数描述（可选）
   - 选择参数分类（可选）
4. 编辑或删除现有系统参数

**业务规则**：
- 参数键必须唯一
- 参数值可以是文本或JSON格式
- 系统参数用于存储系统配置和业务规则参数

### 9.2 默认值和业务规则参数示例

**默认值参数**：
- `default_project_status`：默认项目状态（值：'pending_start'）
- `default_task_status`：默认任务状态（值：'in_progress'）
- `default_contribution_status`：默认专业贡献状态（值：'pending'）

**业务规则参数**：
- `max_project_budget_amount`：项目预算最大金额（值：1000000）
- `min_contribution_points`：专业贡献最小积分（值：1）
- `work_hours_per_day`：每天标准工时（值：8）

## 十、权限控制规则

### 10.1 系统设置权限

**查看权限**：
- 系统管理员可以查看所有系统设置
- 普通用户不能访问系统设置页面

**操作权限**：
- 系统管理员可以创建、编辑、删除所有系统设置
- 普通用户不能进行任何系统设置操作

### 10.2 各设置模块权限

**人日成本设置**：
- 只有系统管理员可以管理

**角色权限设置**：
- 只有系统管理员可以管理

**审批流程设置**：
- 只有系统管理员可以管理

**节假日管理**：
- 只有系统管理员可以管理

**客户部管理**：
- 只有系统管理员可以管理

**供应商管理**：
- 只有系统管理员可以管理

**通知设置**：
- 只有系统管理员可以管理

**系统参数设置**：
- 只有系统管理员可以管理

## 十一、总结

系统设置模块的核心逻辑是：
1. **人日成本设置**：设置不同员工级别和城市类型的人日成本标准，支持生效时间范围
2. **角色权限设置**：创建和管理系统角色，为角色分配权限
3. **审批流程设置**：为不同审批类型配置审批步骤，支持多步骤审批
4. **节假日管理**：管理节假日数据，支持自动同步和手动配置
5. **客户部管理**：管理客户部信息，用于业务实体的归属部门选择
6. **供应商管理**：管理供应商信息，用于外包费用选择
7. **通知设置**：配置各种通知的发送渠道和模板
8. **系统参数设置**：管理系统参数和业务规则参数

主要特点：
1. 统一的系统设置管理界面，集中管理所有系统配置
2. 支持启用/禁用配置，灵活控制功能使用
3. 支持历史版本管理，便于追溯和查询
4. 严格的权限控制，只有系统管理员可以管理
5. 支持批量导入和导出，便于数据维护
6. 系统参数支持文本和JSON格式，灵活存储配置

