# 业绩管理模块业务逻辑规则

**术语说明**：本文档中"登记金额"和"业绩金额"是同一概念，均指 `registrationAmount` 字段。登记金额就是业绩金额。

## 一、数据模型

### 1.1 核心实体

#### PerformanceRecord（业绩记录）

**关联关系**：
- 项目制/离岸制/驻场制：通过 `projectId` 关联到项目
- 计件制：通过 `demandCode`/`demandName` 关联到需求

**核心字段**：
- `registrationStatus`: 登记状态（'未登记' | '已登记'）
- `registrationAmount`: 业绩金额（登记金额）
- `completedAmount`: 完成业绩（进度 × 业绩金额，项目制/计件制自动计算）
- `acceptanceAmount`: 验收业绩（已验收的金额，从验收记录汇总）
- `recordMonth`: 需求月份（格式：YYYY-MM，所有类型必填）
- `needSettlement`: 是否需要结算（'需要结算' | '无需结算'），默认'需要结算'

**业务规则**：

**业绩金额和需求月份**：

| 项目类型 | 业绩金额来源 | 需求月份来源 | 登记时可修改 |
|---------|------------|------------|------------|
| 项目制 | 从项目业绩金额获取 | 从项目计划开始日期自动获取 | 金额、月份均可修改 |
| 计件制 | 从需求金额获取 | 从需求开始日期自动获取 | 金额、月份均可修改 |
| 离岸制/驻场制 | 手动按月录入 | 手动录入 | 金额、月份均可修改 |

**同步更新**：
- 业绩金额修改后，需同步更新关联项目/需求的业绩金额（`contractAmount`）
- 需求月份修改后，**不**同步到关联项目/需求的开始日期（仅保存在业绩记录中）
- 离岸制/驻场制：项目总业绩金额 = 累加所有月份业绩记录的金额

**完成业绩计算规则**：

**项目制/计件制**：
- 完成业绩 = 项目进度 × 业绩金额
- 项目进度 = sum(阶段.percentage × 阶段完成百分比 / 100)
- 实时计算：项目进度更新时（阶段完成百分比变化或阶段完成），自动更新完成业绩
- 计算公式：`completedAmount = (progress / 100) × registrationAmount`
- 完成业绩自动同步到业绩记录

**离岸制/驻场制**：
- 不使用阶段模板，不计算完成业绩
- 按月手动录入业绩，录入的业绩即代表完成业绩
- 录入时间通常在月底或次月初（不限制）
- 项目总完成业绩 = 累加所有月份业绩记录的金额

**完成业绩展示**：
- 项目列表：显示完成业绩（项目制/计件制显示计算值，离岸制/驻场制显示累加值）
- 项目详情：显示完成业绩计算明细（阶段完成情况、进度、完成业绩）
- 业绩管理：显示登记业绩、完成业绩、验收业绩的对比

**结算需求设置（`needSettlement`）**：
- 由**负责结算的人员**设置，可以随时设置
- 默认'需要结算'，未设置时默认为'需要结算'
- 设置为'无需结算'后，不能创建结算记录
- **如果已有结算记录，则不能再设置为'无需结算'**

#### PerformanceAcceptance（验收记录）

**核心字段**：
- `acceptanceMonth`: 验收月份（格式：YYYY-MM）
- `acceptanceAmount`: 验收金额
- `approvalStatus`: 审批状态（'pending' | 'approved' | 'rejected'）
- `attachmentUrl`: 需求平台截图

**业务流程**：
1. 用户在需求平台看到已验收
2. 在本系统申请验收（填写验收月份、验收金额、上传截图）
3. 审批人员核对后审批确认

**规则**：
- 必须审批通过（`approved`）才计入验收金额
- 支持分批验收
- 验收金额不能超过业绩金额
- **验证规则**：创建验收记录时，`acceptanceAmount <= registrationAmount - totalAcceptanceAmount`（确保总验收金额不超过业绩金额）

#### PerformanceSettlement（结算记录）

**核心字段**：
- `settlementDate`: 结算日期（为空=待结算，有值=已结算）
- `settlementAmount`: 结算金额（发起时必须输入，完成时不可修改）
- `status`: 结算状态（'pending' | 'completed'），以明确区分待结算和已结算状态

**业务流程**：

**1. 设置结算需求（`needSettlement`）**
- 设置位置：业绩详情页、发起结算弹窗
- 设置规则：
  - 默认'需要结算'
  - 已有结算记录时，不能设置为'无需结算'
  - 设置为'无需结算'后，不能创建结算记录，但可以改回'需要结算'

**2. 发起结算**
- 前置条件：
  - `needSettlement !== '无需结算'`
  - 已验收（`totalAcceptanceAmount > 0`）
  - 有剩余可结算金额（`remainingSettlementAmount > 0`）
- 操作流程：
  1. 输入结算金额（必填，> 0）
  2. **验证规则**：`settlementAmount <= totalAcceptanceAmount - totalSettlementAmount - pendingSettlementAmount`（确保总结算金额不超过验收金额）
  3. 提交后创建结算记录，`settlementDate` 为空，`status` 为 'pending'（待结算）
- 金额计算：`remainingSettlementAmount = totalAcceptanceAmount - totalSettlementAmount - pendingSettlementAmount`
- 支持分批结算
- **约束**：总结算金额（已完成 + 待结算）不能超过验收金额

**3. 完成结算**
- 对于待结算记录（`status === 'pending'` 或 `settlementDate` 为空），更新结算日期完成结算
- 更新 `settlementDate` 为实际结算日期，`status` 为 'completed'（已结算）
- 结算日期不能是未来日期
- 结算金额在发起时已确定，完成时不可修改

#### PerformancePayment（到账记录）

**核心字段**：
- `paymentDate`: 到账日期（必填）
- `paymentAmount`: 到账金额（必填）

**业务流程**：
- 财务核对后录入到账信息
- 必须输入到账金额（> 0）和到账日期
- 到账金额 ≤ 剩余未到账的业绩金额
- 计算公式：`paymentAmount <= registrationAmount - totalPaymentAmount`

**规则**：
- **到账与结算无关**，不需要等待结算完成
- 支持分批到账
- 总到账金额不能超过业绩金额（`totalPaymentAmount <= registrationAmount`）

#### PerformanceSplit（业绩拆分记录）

**说明**：记录业绩拆分到不同部门的情况，用于处理跨部门借人时的业绩分配。

**核心字段**：
- `id`: 拆分记录ID
- `performanceId`: 关联的业绩记录ID
- `department`: 拆分到的部门（Department枚举）
- `splitAmount`: 拆分金额（必填，必须 > 0）
- `splitReason`: 拆分原因（可选，用于记录借人情况说明）
- `operatorId`: 操作人ID（归属部门主管）
- `operatorName`: 操作人姓名
- `createdAt`: 创建时间（时间戳）
- `updatedAt`: 更新时间（时间戳）

**业务规则**：
- 业绩默认属于项目的归属部门，如果未拆分，则全部归属于归属部门
- 拆分由**项目归属部门主管**进行操作
- 拆分方式：线下协商后，由归属部门主管在系统中录入拆分结果
- **拆分金额验证**：所有拆分记录的金额合计必须等于业绩金额（`sum(splitAmount) === registrationAmount`）
- 支持多次拆分和修改拆分（修改时需重新验证合计金额）
- 拆分记录可以删除，删除后需重新验证合计金额

#### PerformanceChangeLog（变更日志）

**说明**：记录业绩记录及其相关数据的状态变更历史，用于追踪操作轨迹和审计。

**核心字段**：
- `performanceId`: 关联的业绩记录ID
- `changeType`: 变更类型（'registration_status' | 'registration_amount' | 'need_settlement' | 'acceptance' | 'settlement' | 'payment' | 'split'）
- `changeField`: 变更的字段名称
- `oldValue`: 变更前的值
- `newValue`: 变更后的值
- `operatorId`: 操作人ID
- `operatorName`: 操作人姓名
- `changeTime`: 变更时间（时间戳）
- `description`: 变更说明（可选）

**需要记录变更的操作**：
1. **登记状态变更**：`registrationStatus` 从'未登记'变为'已登记'
2. **业绩金额变更**：`registrationAmount` 的修改
3. **验收记录创建/审批**：创建验收记录、审批通过/拒绝
4. **结算记录创建/完成**：发起结算、完成结算
5. **到账记录创建**：录入到账信息
6. **业绩拆分创建/修改/删除**：创建拆分记录、修改拆分金额、删除拆分记录

**业务规则**：
- 每次状态变更或重要字段修改时，自动创建变更日志记录
- 变更日志不可修改、不可删除（只读）
- 变更日志按时间倒序排列，便于查看最新变更

## 二、状态流转规则

### 2.1 登记状态
```
未登记 → 已登记
```
- **触发条件**：主管在需求平台查看到登记后，在系统里将状态改为已登记
- **需求月份初始化**：
  - 项目制/计件制：自动从关联项目/需求的计划开始日期获取，格式转换为 YYYY-MM
  - 离岸制/驻场制：手动录入
- **登记时的处理**：
  - 项目制/计件制：初始金额从关联项目/需求获取，金额和月份均可修改
  - 离岸制/驻场制：金额和月份均为手动录入，可修改
  - 业绩金额修改后，需同步更新关联项目/需求的业绩金额（`contractAmount`）
  - 需求月份修改后，**不**同步到关联项目/需求的开始日期（仅保存在业绩记录中）
  - 离岸制/驻场制：项目总业绩金额 = 累加所有月份业绩记录的金额
- **变更记录**：
  - 状态从'未登记'变为'已登记'时，记录变更日志
  - 业绩金额修改时，记录变更日志（变更前后值、操作人、变更时间）

### 2.2 验收状态
```
未验收 → 部分验收 → 全部验收
```
- **状态计算**：
  - `未验收`: `totalAcceptanceAmount === 0`
  - `部分验收`: `0 < totalAcceptanceAmount && Math.abs(totalAcceptanceAmount - registrationAmount) >= 0.01`
  - `全部验收`: `Math.abs(totalAcceptanceAmount - registrationAmount) < 0.01` 或 `totalAcceptanceAmount >= registrationAmount * 0.999`（允许 0.1% 误差）
- **业务规则**：
  - 验收记录必须经过审批（`approvalStatus === 'approved'`）才计入
  - 验收金额可以分批录入（多条验收记录）
  - **不存在"有金额但未验收"的情况**（验收审批是在需求平台验收后申请确认）

### 2.3 结算状态
```
无需结算 | 未结算 → 待结算 → 部分结算 → 全部结算
```
- **状态计算**：
  - `无需结算`: `needSettlement === '无需结算'`
  - `未结算`: `needSettlement !== '无需结算' && 无结算记录`
  - `待结算`: `needSettlement !== '无需结算' && 有结算记录但 settlementDate 为空`
  - `部分结算`: `0 < totalSettlementAmount && Math.abs(totalSettlementAmount - registrationAmount) >= 0.01`
  - `全部结算`: `Math.abs(totalSettlementAmount - registrationAmount) < 0.01` 或 `totalSettlementAmount >= registrationAmount * 0.999`（允许 0.1% 误差）
- **业务规则**：
  - 发起结算前置条件：`needSettlement !== '无需结算'`、已验收、有剩余可结算金额
  - 结算金额 ≤ 剩余未结算的已验收金额（结算金额约束基于验收金额）
  - **结算状态判断基于业绩金额**（全部结算的判断以业绩金额为准）
  - 支持分批结算
  - 完成结算：更新待结算记录的 `settlementDate`，结算日期不能是未来日期

### 2.4 到账状态
```
未到账 → 部分到账 → 全部到账
```
- **状态计算**：
  - `未到账`: `totalPaymentAmount === 0`
  - `部分到账`: `0 < totalPaymentAmount && Math.abs(totalPaymentAmount - registrationAmount) >= 0.01`
  - `全部到账`: `Math.abs(totalPaymentAmount - registrationAmount) < 0.01` 或 `totalPaymentAmount >= registrationAmount * 0.999`（允许 0.1% 误差）
- **业务规则**：
  - **到账与结算无关**，不需要等待结算完成
  - 到账金额 ≤ 剩余未到账的业绩金额
  - 支持分批到账

## 三、金额计算逻辑

### 3.1 验收金额
```typescript
totalAcceptanceAmount = sum(acceptances
  .filter(a => a.approvalStatus === 'approved')
  .map(a => a.acceptanceAmount))
```

### 3.2 结算金额
```typescript
// 已完成的结算金额（status === 'completed' 或 settlementDate 有值）
totalSettlementAmount = sum(settlements
  .filter(s => (s.status === 'completed' || s.settlementDate) && s.settlementAmount > 0)
  .map(s => s.settlementAmount))

// 待结算金额（status === 'pending' 或 settlementDate 为空）
pendingSettlementAmount = sum(settlements
  .filter(s => (s.status === 'pending' || !s.settlementDate) && s.settlementAmount > 0)
  .map(s => s.settlementAmount))
```
- **注意**：
  - 只统计已完成的结算（`status === 'completed'` 或有日期和金额）计入 `totalSettlementAmount`
  - 待结算的金额（`status === 'pending'` 或有金额但日期为空）计入 `pendingSettlementAmount`
  - **总结算金额约束**：`totalSettlementAmount + pendingSettlementAmount <= totalAcceptanceAmount`
  - 发起结算时必须输入结算金额，且不能超过剩余可结算金额（`remainingSettlementAmount`）
  - 剩余可结算金额 = 已验收金额 - 已完成结算金额 - 待结算金额

### 3.3 到账金额
```typescript
// 已到账总金额
totalPaymentAmount = sum(payments.map(p => p.paymentAmount))

// 剩余未到账金额（基于业绩金额）
remainingPaymentAmount = registrationAmount - totalPaymentAmount
```
- **注意**：
  - **到账与结算无关**：到账金额只和业绩金额有关，不需要等待结算完成
  - 到账金额可以分批录入
  - 每次录入的到账金额不能超过剩余未到账的业绩金额
  - 剩余未到账金额 = 业绩金额 - 已到账金额
  - 总到账金额不能超过业绩金额（`totalPaymentAmount <= registrationAmount`）

### 3.4 待处理金额
- `pendingAcceptanceAmount = registrationAmount - totalAcceptanceAmount`（仅当已登记时）
- `pendingSettlementAmount`（待结算金额）= 已发起但未完成的结算金额总和
  - `pendingSettlementAmount = sum(settlements.filter(s => !s.settlementDate && s.settlementAmount > 0).map(s => s.settlementAmount))`
- `remainingSettlementAmount`（剩余可结算金额）= 已验收金额 - 已完成结算金额 - 待结算金额
  - `remainingSettlementAmount = totalAcceptanceAmount - totalSettlementAmount - pendingSettlementAmount`
  - 发起结算时，结算金额不能超过 `remainingSettlementAmount`
- `remainingPaymentAmount`（剩余未到账金额）= 业绩金额 - 已到账金额
  - `remainingPaymentAmount = registrationAmount - totalPaymentAmount`
  - 录入到账时，到账金额不能超过 `remainingPaymentAmount`
  - **注意**：到账与结算无关，不需要等待结算完成

## 四、业务约束规则

### 4.1 前置条件
1. **验收前置**：只有 `registrationStatus === '已登记'` 的业绩才能有验收记录
2. **结算前置**：
   - 只有已验收的业绩才能发起结算（`totalAcceptanceAmount > 0`）
   - 只有 `needSettlement !== '无需结算'` 的业绩才能创建结算记录
3. **到账前置**：到账与结算无关，不需要前置条件，可以随时录入到账信息

### 4.2 金额约束
1. **验收金额**：
   - 总验收金额：`totalAcceptanceAmount <= registrationAmount`
   - **验证规则**：创建验收记录时，`acceptanceAmount <= registrationAmount - totalAcceptanceAmount`（确保总验收金额不超过业绩金额）
   - 支持部分验收，可以分批对业绩金额进行验收
2. **结算金额**：
   - 单次结算金额：`settlementAmount <= totalAcceptanceAmount - totalSettlementAmount - pendingSettlementAmount`
     - 不能超过剩余未结算的已验收金额
     - 支持部分结算，可以分批对已验收金额进行结算
   - **总结算金额约束**：`totalSettlementAmount + pendingSettlementAmount <= totalAcceptanceAmount`（已完成 + 待结算不能超过验收金额）
   - **验证规则**：发起结算时，必须验证 `settlementAmount <= totalAcceptanceAmount - totalSettlementAmount - pendingSettlementAmount`
3. **到账金额**：
   - **到账与结算无关**：到账金额只和业绩金额有关，不需要等待结算完成
   - 单次到账金额：`paymentAmount <= registrationAmount - totalPaymentAmount`
     - 不能超过剩余未到账的业绩金额
     - 支持分批到账，可以分批对业绩金额进行到账
   - 总到账金额：`totalPaymentAmount <= registrationAmount`
   - **验证规则**：录入到账时，`paymentAmount <= registrationAmount - totalPaymentAmount`

### 4.3 业绩拆分约束
1. **拆分权限**：只有项目归属部门主管可以进行业绩拆分操作
2. **拆分金额验证**：
   - 所有拆分记录的金额合计必须等于业绩金额：`sum(splitAmount) === registrationAmount`
   - 单次拆分金额必须 > 0
   - 拆分金额不能超过剩余未拆分金额
3. **拆分规则**：
   - 如果未拆分，则全部业绩归属于项目归属部门
   - 拆分后，归属部门和其他被拆分部门都会显示对应的拆分金额
   - 支持多次拆分和修改拆分（修改时需重新验证合计金额）
   - 拆分记录可以删除，删除后需重新验证合计金额
4. **拆分时机**：可以在业绩登记后的任何时间进行拆分，不影响验收、结算、到账流程

### 4.4 数据完整性
1. **验收记录**：必须关联到业绩记录（`performanceId`）
2. **结算记录**：
   - 必须关联到业绩记录（`performanceId`）
   - 只有 `needSettlement !== '无需结算'` 的业绩才能创建结算记录
   - 如果已有结算记录，则不能再设置为'无需结算'
3. **到账记录**：
   - 必须关联到业绩记录（`performanceId`）
   - **到账与结算无关**，可以随时录入到账信息
4. **业绩拆分记录**：
   - 必须关联到业绩记录（`performanceId`）
   - 拆分金额合计必须等于业绩金额
   - 拆分记录可以修改和删除
5. **业绩记录与项目/需求的关联**：
   - 项目制/离岸制/驻场制：必须关联到项目（`projectId`）
   - 计件制：必须关联到需求（`demandCode`/`demandName`）
   - 所有类型必须填写 `recordMonth`（需求月份）
6. **变更日志**：
   - 必须关联到业绩记录（`performanceId`）
   - 记录所有状态变更和重要字段修改
   - 变更日志不可修改、不可删除（只读）
   - 用于追踪操作轨迹和审计

## 五、业绩拆分规则

### 5.1 拆分前置条件

**可拆分的业绩**：
- 已登记的业绩（`registrationStatus === '已登记'`）
- 未登记的业绩也可以进行拆分（但通常在实际登记后进行拆分）

**拆分权限**：
- 只有项目归属部门主管可以进行业绩拆分操作
- 系统自动判断当前用户是否为项目归属部门主管

### 5.2 拆分操作流程

**拆分操作**：
1. 在业绩详情页点击"业绩拆分"按钮
2. 显示当前拆分情况：
   - 如果未拆分：显示"未拆分，全部归属于[归属部门]"
   - 如果已拆分：显示拆分列表（部门、金额、操作人、时间）
3. 点击"新增拆分"或"修改拆分"按钮
4. 填写拆分信息：
   - 选择拆分到的部门（必填）
   - 输入拆分金额（必填，必须 > 0）
   - 填写拆分原因（可选，用于记录借人情况说明）
5. 系统实时验证：拆分金额合计不能超过业绩金额
6. 提交后创建或更新拆分记录

**拆分验证规则**：
- 单次拆分金额必须 > 0
- 拆分金额合计不能超过业绩金额：`sum(splitAmount) <= registrationAmount`
- 提交时验证：拆分金额合计必须等于业绩金额：`sum(splitAmount) === registrationAmount`
- 如果拆分金额合计小于业绩金额，显示提示："拆分金额合计为 ¥X.XX，还需拆分 ¥Y.YY"
- 如果拆分金额合计大于业绩金额，显示错误："拆分金额合计为 ¥X.XX，超过业绩金额 ¥Y.YY，请调整"

**拆分修改和删除**：
- 支持修改已有拆分记录的金额和原因
- 支持删除拆分记录
- 修改或删除后，需重新验证拆分金额合计是否等于业绩金额

### 5.3 拆分显示规则

**业绩列表显示**：
- 显示业绩总金额
- 如果已拆分，显示拆分部门数量和拆分总金额（合计应等于业绩金额）

**业绩详情显示**：
- 显示业绩总金额
- 显示拆分列表：
  - 归属部门：显示归属部门名称和拆分金额（如果未拆分，显示全部业绩金额）
  - 其他部门：显示被拆分部门名称、拆分金额、拆分原因、操作人、操作时间
- 显示拆分合计：`拆分合计：¥X.XX（应等于业绩金额 ¥Y.YY）`

**部门业绩统计**：
- 业绩拆分后，各被拆分部门可以在部门业绩统计中看到对应的拆分金额
- 归属部门显示归属金额（业绩总金额 - 其他部门拆分金额）

## 六、交互设计

### 6.1 结算需求设置交互

**设置位置**：
- **业绩详情页**：在结算信息区域显示当前结算需求状态，提供"设置结算需求"操作按钮
- **发起结算弹窗**：如果 `needSettlement` 还未设置，可以在发起结算时同时设置

**UI 状态**：
- **显示当前状态**：
  - 如果 `needSettlement === '需要结算'` 或未设置（默认），显示："结算需求：需要结算"
  - 如果 `needSettlement === '无需结算'`，显示："结算需求：无需结算"（灰色文字）
- **操作按钮**：
  - 如果 `needSettlement === '需要结算'` 或未设置，显示："设置为无需结算"按钮
  - 如果 `needSettlement === '无需结算'`，显示："设置为需要结算"按钮
  - **禁用规则**：如果已经有结算记录，禁用"设置为无需结算"按钮，并显示提示："已有结算记录，不能设置为无需结算"

**交互流程**：
1. 点击"设置结算需求"按钮，打开设置弹窗
2. 选择"需要结算"或"无需结算"
3. 如果选择"无需结算"且已有结算记录，显示错误提示，不允许保存
4. 保存后更新状态，刷新UI

### 6.2 发起结算交互

**按钮显示规则**：
- **显示条件**：
  - `needSettlement !== '无需结算'`（如果为"无需结算"，不显示"发起结算"按钮）
  - 已验收（`totalAcceptanceAmount > 0`）
  - 有剩余可结算金额（`remainingSettlementAmount > 0`）
- **按钮状态**：
  - 如果满足条件，显示"发起结算"按钮（蓝色）
  - 如果不满足条件，按钮禁用或隐藏，并显示原因提示

**发起结算弹窗**：
- **表单字段**：
  1. **结算需求设置**（如果还未设置）：
     - 单选："需要结算" / "无需结算"
     - 默认选中"需要结算"
     - 如果已有结算记录，隐藏此选项（因为已默认为"需要结算"）
  2. **结算金额**（必填）：
     - 输入框，支持小数
     - 显示提示：`可结算金额：¥X.XX万（剩余：¥X.XX万）`
     - 实时验证：结算金额不能超过剩余可结算金额
     - 错误提示：如果超过，显示"结算金额不能超过剩余可结算金额 ¥X.XX万"
- **提交规则**：
  - 如果 `needSettlement` 还未设置，必须选择"需要结算"或"无需结算"
  - 结算金额必须 > 0
  - 结算金额不能超过剩余可结算金额
- **提交后**：
  - 创建结算记录，`settlementDate` 为空（表示待结算）
  - 如果同时设置了 `needSettlement`，更新业绩记录的 `needSettlement`
  - 刷新页面，显示新的结算记录

### 6.3 完成结算交互

**操作位置**：业绩详情页，结算记录列表

**列表显示**：
- 每条结算记录显示：
  - 结算金额
  - 结算状态（待结算 / 已结算）
  - 结算日期（待结算时显示"-"）
  - 操作按钮（待结算时显示"完成结算"按钮）

**完成结算操作**：
1. 点击"完成结算"按钮，打开完成结算弹窗
2. 选择或输入结算日期（必填，日期选择器）
3. 显示结算金额（只读，不可修改）
4. 提交后更新 `settlementDate`，状态变为"已结算"
5. 刷新页面，更新结算状态

**验证规则**：
- 结算日期不能是未来日期
- 结算金额在发起时已确定，完成时不可修改

### 6.4 结算状态显示

**状态标签**：
- **无需结算**：灰色标签，不显示"发起结算"按钮
- **未结算**：蓝色标签，显示"发起结算"按钮
- **待结算**：橙色标签，显示"发起结算"按钮（如果还有剩余可结算金额）
- **部分结算**：黄色标签，显示"发起结算"按钮（如果还有剩余可结算金额）
- **全部结算**：绿色标签，不显示"发起结算"按钮（判断标准：结算金额达到业绩金额）

**金额显示**：
- 显示已结算金额和待结算金额
- 格式：`已结算：¥X.XX万 / 待结算：¥X.XX万`
- 如果全部结算完成，只显示：`已结算：¥X.XX万`

## 七、显示逻辑

### 7.1 列显示规则
- **所有列始终显示**：验收信息列、结算信息列、到账信息列始终存在，不会因为数据为空而隐藏

### 7.2 数据展示规则
- **验收信息**：如果 `acceptedAmount > 0`，显示验收状态、验收月份、验收金额；否则显示 "-"
- **结算信息**：如果 `hasPendingSettlement || settledAmount > 0`，显示结算状态、结算日期、结算金额；否则显示 "-"
- **到账信息**：如果 `paidAmount > 0 || pendingPaymentAmount > 0`，显示到账状态、到账日期、到账金额；否则显示 "-"

## 八、筛选逻辑

### 8.1 验收状态筛选
- 未登记的不可能有验收状态，筛选"未验收"时包含未登记记录
- 已登记但未验收的记录，验收状态为"未验收"

### 8.2 结算状态筛选
- 未登记的不可能有结算状态
- 筛选时会匹配 `settlementStatus`（无需结算、未结算、待结算、部分结算、全部结算）

### 8.3 到账状态筛选
- 到账与结算无关，可以随时录入到账信息
- 筛选时会匹配 `paymentStatus`（未到账、部分到账、全部到账）

## 八点五、驻场制项目成本计算规则

### 8.5.1 成本计算与业绩登记关联

**说明**：驻场制项目的成本计算与业绩登记关联，每个月登记业绩时会选择人员，系统自动计算成本。

**业务流程**：
1. 项目经理或财务人员在业绩管理模块登记驻场制项目的月度业绩
2. 登记业绩时，选择参与人员（可多选，从员工列表选择）
3. 系统自动计算该月的项目成本：
   - 根据选择的员工，查找该员工该月的完全人力成本（从 `employee_monthly_costs` 表获取）
   - 如果找不到对应的成本记录，提示错误："员工 [姓名] 在 [月份] 的完全人力成本未录入，请先在成本管理模块录入该员工的月度成本"
   - 不允许提交业绩登记，直到所有选择员工的月度成本都已录入
   - 项目成本 = 所有选择员工的完全人力成本总和
4. 系统自动创建项目成本记录（或更新现有记录）

**业务规则**：
- 驻场制项目的成本必须基于已录入的员工月度完全人力成本
- 如果员工该月的完全人力成本未录入，不允许提交业绩登记
- 项目成本 = sum(选择员工的完全人力成本.totalCost)
- 成本记录与业绩记录关联（通过月份关联）
- 成本记录由系统自动创建，财务人员可以查看和核对

### 8.5.2 成本记录管理

**说明**：驻场制项目的成本记录由系统自动创建，财务人员可以查看和核对。

**业务流程**：
1. 财务人员在成本管理模块查看驻场制项目的成本记录
2. 查看成本明细：
   - 按月份查看
   - 查看每个月的参与人员和成本
   - 查看项目总成本
3. 如果发现成本记录有误，可以：
   - 修改员工的月度完全人力成本（如果录入错误）
   - 重新登记业绩（如果人员选择错误）

**业务规则**：
- 成本记录由系统自动创建，财务人员不能手动创建或删除
- 如果修改员工的月度完全人力成本，系统自动重新计算关联的项目成本
- 如果重新登记业绩（修改人员选择），系统自动更新项目成本记录

### 8.5.3 业绩登记表单增强

**驻场制项目业绩登记表单**：
- 在原有的业绩登记表单基础上，增加"参与人员"选择字段
- 参与人员：多选下拉框，从员工列表选择
- 选择参与人员后，系统实时验证：
  - 检查每个员工该月的完全人力成本是否已录入
  - 如果未录入，显示错误提示："员工 [姓名] 在 [月份] 的完全人力成本未录入"
  - 如果全部已录入，显示成本预览："预计成本：¥X.XX（基于已选择的 [N] 名员工）"
- 提交业绩登记时，系统自动创建成本记录

**成本预览显示**：
- 显示每个员工的成本明细（员工姓名、员工级别、城市类型、人日成本、总成本）
- 显示项目总成本
- 成本预览只读，不可编辑

## 九、权限控制规则

### 9.1 业绩管理权限

**创建权限**：
- 系统根据项目类型自动创建业绩记录（项目制/计件制在项目创建审批通过后，离岸制/驻场制手动创建）

**编辑权限**：
- 归属部门主管可以编辑该部门的业绩记录
- 负责结算的人员可以设置结算需求

**查看权限**：
- 所有用户都可以查看业绩列表和详情
- 可以根据部门权限限制查看范围

### 9.2 验收权限

**创建验收记录权限**：
- 归属部门主管可以创建验收记录
- 项目经理可以创建验收记录

**审批验收权限**：
- 审批人员可以审批验收记录（根据审批流程配置）

### 9.3 结算权限

**设置结算需求权限**：
- 负责结算的人员可以设置结算需求

**发起结算权限**：
- 负责结算的人员可以发起结算

**完成结算权限**：
- 负责结算的人员可以完成结算

### 9.4 到账权限

**录入到账权限**：
- 财务人员可以录入到账信息

### 9.5 业绩拆分权限

**拆分权限**：
- 只有项目归属部门主管可以进行业绩拆分操作

## 十、总结

业绩管理模块的核心逻辑是：
1. **登记** → **验收**（需审批）→ **结算**（可分批）→ **到账**（可分批）
2. 每个阶段都有明确的前置条件和状态判断规则
3. 金额计算需要考虑分批录入的情况
4. 状态判断需要考虑边界情况和数据完整性

主要特点：
1. 业绩金额与项目/需求关联，支持双向同步更新
2. 验收、结算、到账流程独立，支持分批操作
3. 到账与结算无关，可以随时录入到账信息
4. 支持业绩拆分功能，处理跨部门借人时的业绩分配
5. 支持变更日志记录，便于追踪操作轨迹和审计
6. 金额计算和状态判断有明确的验证规则和约束条件

