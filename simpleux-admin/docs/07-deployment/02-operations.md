# 运维手册

## 一、监控告警

### 1.1 监控指标

**应用监控**：

- 响应时间
- 错误率
- 请求量
- 服务器资源使用

**数据库监控**：

- 连接数
- 查询性能
- 存储使用
- 慢查询

**业务监控**：

- 用户活跃度
- 关键操作数量
- 审批流程状态
- 数据同步状态

### 1.2 告警配置

**告警规则**：

- 响应时间 > 3 秒
- 错误率 > 1%
- 服务器 CPU > 80%
- 服务器内存 > 80%
- 数据库连接数 > 80%

**告警通知**：

- 邮件通知
- 钉钉通知
- 短信通知（紧急）

## 二、日志管理

### 2.1 日志分类

**应用日志**：

- 访问日志
- 错误日志
- 业务日志
- 性能日志

**日志级别**：

- ERROR：错误信息
- WARN：警告信息
- INFO：一般信息
- DEBUG：调试信息

### 2.2 日志收集

**日志存储**：

- 使用日志服务（如 Logtail、Datadog）
- 或使用文件日志

**日志保留**：

- 访问日志：30 天
- 错误日志：90 天
- 业务日志：180 天

### 2.3 日志分析

**常用查询**：

```bash
# 查看错误日志
grep ERROR app.log

# 查看慢查询
grep "slow query" app.log

# 统计错误数量
grep ERROR app.log | wc -l
```

## 三、备份恢复

### 3.1 数据备份

**自动备份**：

- Supabase 自动备份
- 配置备份保留策略

**手动备份**：

```bash
# 备份数据库
pg_dump -h <host> -U <user> -d <database> > backup_$(date +%Y%m%d).sql

# 压缩备份
gzip backup_$(date +%Y%m%d).sql
```

### 3.2 备份策略

**备份频率**：

- 每日备份
- 每周全量备份
- 每月归档备份

**备份验证**：

- 定期测试备份恢复
- 验证备份完整性

### 3.3 恢复流程

**数据库恢复**：

```bash
# 恢复数据库
psql -h <host> -U <user> -d <database> < backup.sql

# 或使用Supabase Dashboard恢复
```

**应用恢复**：

- 回滚到之前的版本
- 恢复配置文件
- 重启应用

## 四、故障处理

### 4.1 常见故障

**应用故障**：

- 应用无法启动
- 接口返回 500 错误
- 页面加载缓慢

**数据库故障**：

- 数据库连接失败
- 查询超时
- 数据不一致

**第三方服务故障**：

- 钉钉 API 调用失败

### 4.2 故障处理流程

**1. 故障发现**：

- 监控告警
- 用户反馈
- 日志分析

**2. 故障定位**：

- 查看错误日志
- 检查系统资源
- 分析错误堆栈

**3. 故障处理**：

- 临时解决方案
- 根本原因分析
- 永久解决方案

**4. 故障恢复**：

- 验证修复效果
- 监控系统状态
- 记录故障报告

### 4.3 故障预案

**应用故障预案**：

- 重启应用
- 回滚版本
- 切换到备用服务器

**数据库故障预案**：

- 切换到备用数据库
- 恢复数据备份
- 联系 Supabase 支持

## 五、性能优化

### 5.1 性能监控

**关键指标**：

- 页面加载时间
- API 响应时间
- 数据库查询时间
- 服务器资源使用

**性能分析**：

- 使用性能分析工具
- 识别性能瓶颈
- 优化慢查询

### 5.2 优化策略

**应用优化**：

- 代码优化
- 缓存策略
- 代码分割
- 图片优化

**数据库优化**：

- 索引优化
- 查询优化
- 连接池优化
- 统计信息更新

## 六、安全运维

### 6.1 安全监控

**安全事件**：

- 异常登录
- 权限异常
- 数据泄露
- 攻击行为

**安全日志**：

- 登录日志
- 操作日志
- 错误日志
- 访问日志

### 6.2 安全加固

**定期检查**：

- 更新依赖包
- 检查安全漏洞
- 更新 SSL 证书
- 审查权限配置

**安全更新**：

- 及时安装安全补丁
- 更新第三方库
- 修复安全漏洞

## 七、容量规划

### 7.1 容量监控

**资源使用**：

- CPU 使用率
- 内存使用率
- 存储使用率
- 网络带宽

**业务增长**：

- 用户增长趋势
- 数据增长趋势
- 请求量增长趋势

### 7.2 扩容策略

**水平扩容**：

- 增加服务器实例
- 负载均衡
- 数据库读写分离

**垂直扩容**：

- 升级服务器配置
- 增加数据库资源
- 优化应用性能

## 八、定期维护

### 8.1 日常维护

**每日任务**：

- 检查系统状态
- 查看错误日志
- 监控告警信息
- 备份数据

### 8.2 每周维护

**每周任务**：

- 性能分析
- 日志清理
- 安全检查
- 容量评估

### 8.3 每月维护

**每月任务**：

- 系统更新
- 安全审计
- 性能优化
- 文档更新

## 九、应急响应

### 9.1 应急流程

**应急响应步骤**：

1. 发现故障
2. 评估影响
3. 启动应急响应
4. 处理故障
5. 恢复服务
6. 总结改进

### 9.2 应急联系人

**联系人列表**：

- 技术负责人
- 运维负责人
- 数据库管理员
- 第三方服务支持

## 十、运维文档

### 10.1 文档维护

**运维文档**：

- 部署文档
- 配置文档
- 故障处理文档
- 应急预案

### 10.2 知识库

**知识积累**：

- 常见问题
- 解决方案
- 最佳实践
- 经验总结
